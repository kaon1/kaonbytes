<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Using Netbox as an Inventory Source of Truth for Ansible while gathering facts to inject back to Netbox"><title>Netbox Dynamic Inventory for Ansible as a feedback loop</title><link rel=canonical href=https://kaonbytes.com/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/><link rel=stylesheet href=/scss/style.min.450926226e724574a6b936335ea06111f8aeb253d932c86cb2cc807341cd2889.css><meta property="og:title" content="Netbox Dynamic Inventory for Ansible as a feedback loop"><meta property="og:description" content="Using Netbox as an Inventory Source of Truth for Ansible while gathering facts to inject back to Netbox"><meta property="og:url" content="https://kaonbytes.com/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/"><meta property="og:site_name" content="KaonBytes"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2022-05-13T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-13T00:00:00+00:00"><meta property="og:image" content="https://kaonbytes.com/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/netbox-ansible-feedback.png"><meta name=twitter:site content="@kaon_123"><meta name=twitter:creator content="@kaon_123"><meta name=twitter:title content="Netbox Dynamic Inventory for Ansible as a feedback loop"><meta name=twitter:description content="Using Netbox as an Inventory Source of Truth for Ansible while gathering facts to inject back to Netbox"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kaonbytes.com/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/netbox-ansible-feedback.png"><link rel="shortcut icon" href=favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-LE0JVZ0N09"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LE0JVZ0N09",{anonymize_ip:!1})}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/profile-pic-newest_hu757f77536bd4ecfb769969738e1bc115_763896_300x0_resize_q75_box.jpg width=300 height=444 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>KaonBytes</a></h1><h2 class=site-description>Welcome to my technical blog on all things Networking, Security and Automation</h2></div></header><ol class=social-menu><li><a href=https://github.com/kaon1 target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/kaon1/ target=_blank title=LinkedIn><svg role="img" xmlns="http://www.w3.org/2000/svg" width="1e3mm" height="1e3mm" viewBox="0 0 1e3 1e3" style="max-width:1.6em;height:auto"><path id="path" style="opacity:1;vector-effect:none;fill:#000;fill-opacity:1" d="M336 332s0 457 0 457-125 0-125 0 0-457 0-457 125 0 125 0m10-126s0 0 0 0c0 41-33 74-73 74s-72-33-72-74c0-40 32-73 72-73s73 33 73 73M834 508s0 281 0 281-125 0-125 0 0-233 0-233c0-140-166-129-166 0V789s-124 0-124 0 0-457 0-457 124 0 124 0 0 74 0 74c58-108 291-116 291 102" transform/></svg></a></li><li><a href=https://twitter.com/kaonthana target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/learning-links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Learning Links</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/><img src=/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/netbox-ansible-feedback_hu91008c89e08c35be24c68bc187db22be_244905_800x0_resize_box_3.png srcset="/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/netbox-ansible-feedback_hu91008c89e08c35be24c68bc187db22be_244905_800x0_resize_box_3.png 800w, /p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/netbox-ansible-feedback_hu91008c89e08c35be24c68bc187db22be_244905_1600x0_resize_box_3.png 1600w" width=800 height=270 loading=lazy alt="Featured image of post Netbox Dynamic Inventory for Ansible as a feedback loop"></a></div><div class=article-details><header class=article-category><a href=/categories/ansible/>ansible</a>
<a href=/categories/automation/>automation</a>
<a href=/categories/netbox/>netbox</a>
<a href=/categories/juniper/>juniper</a>
<a href=/categories/netdevops/>netdevops</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/>Netbox Dynamic Inventory for Ansible as a feedback loop</a></h2><h3 class=article-subtitle>Using Netbox as an Inventory Source of Truth for Ansible while gathering facts to inject back to Netbox</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>May 13, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>6 minute read</time></div></footer></div></header><section class=article-content><p><strong>The most important pillar</strong> of Network Automation is a <strong>Source of Truth</strong> (SoT)</p><p>An accurate and well maintained SoT should provide:</p><ul><li>A list of device inventory (hosts)</li><li>Connection parameters (IP/Hostname, connection protocol/port)</li><li>Global, Regional, or Site specific parameters that are required to maintain desired network state</li></ul><h2 id=the-chicken-or-the-egg-problem>The Chicken or the Egg Problem</h2><p>When dealing with a <a class=link href=https://www.techtarget.com/searchdatacenter/definition/brownfield-site target=_blank rel=noopener>brownfield</a> enterprise environment,
we run into <strong>The Chicken or The Egg Problem</strong> at the beginning of our Network Automation journey.</p><p>The problem is, we need an accurate and well maintained SoT but this requires manual work to gather data from
all currently running devices and keep that data up to date as the network changes. Let&rsquo;s automate this!
But wait, how can we automate this if we don&rsquo;t have a SoT?</p><h3 id=the-solution>The Solution</h3><p>The answer is a staged approach (i.e. bootstrapping):</p><ul><li>Choose your SoT platform, I like <a class=link href=https://github.com/netbox-community/netbox target=_blank rel=noopener>Netbox</a></li><li>Perform some manual work to get a basic static device list as an <a class=link href=https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html target=_blank rel=noopener>ansible inventory file</a></li><li>Run Ansible fact gathering accross all of your inventory</li><li>Use the <a class=link href=https://docs.ansible.com/ansible/latest/collections/netbox/netbox/index.html target=_blank rel=noopener>Netbox Ansible Collection</a> to populate netbox with key information of each device such as name, ip, connection profile, site, etc</li><li>For all future playbooks, use the <a class=link href=https://docs.ansible.com/ansible/latest/collections/netbox/netbox/nb_inventory_inventory.html target=_blank rel=noopener>Netbox Ansible Dynamic Plugin</a>
to populate your ansible inventory.</li><li>Maintain accurate state by repeatedly running (scheduled) fact gathering and keep netbox up to date via Ansible</li></ul><h3 id=diagram>Diagram</h3><p><img src=/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/flow3.png width=4300 height=2304 srcset="/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/flow3_hu74bc40b49169982f83e8df4e84ceb9aa_605967_480x0_resize_box_3.png 480w, /p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/flow3_hu74bc40b49169982f83e8df4e84ceb9aa_605967_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=186 data-flex-basis=447px></p><h3 id=the-code>The Code</h3><p><strong>Bootstrap Playbook</strong> &ndash;> <a class=link href=https://github.com/kaon1/ansible-misc/blob/main/netbox-ansible-populate/netbox-ansible-junos-bootstrap.yml target=_blank rel=noopener>netbox-ansible-junos-bootstrap.yml</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>### Playbook to bootstrap netbox inventory with a list of juniper devices provided by static inventory file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Uses ansible gather_facts to grab net_version, serial number and net_model</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Also perform a dig to get a FQDN which we can use as device name instead of the inventory_name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PB to Bootstrap Netbox Inventory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>junosinv</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>True</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ansible_user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ansible_ssh_private_key_file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>netbox_url</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>netbox_token</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_network_os }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>site</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>device_role</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;access_switch&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Check if net_version exists&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>### If ansible_facts does not provide net_version we manually fill it in as 111</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>net_version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;111&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>ansible_facts[&#39;net_version&#39;] is undefined</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Assign net version&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>net_version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_facts[&#39;net_version&#39;] }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>ansible_facts[&#39;net_version&#39;] is defined</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>### Optional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Resolve FQDN Hostname - perform DIG&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>### Perform linux DIG command to get the reverse DNS record for the IP. THis will be our new hostname for netbox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>raw</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;dig -x {{ ansible_host }} +short | sed -e &#39;s/.$//&#39;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>dig_result</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>### Optional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;TASK 11: Assign dig result to fqdn var&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>### If Reverse DNS exists, trim whhite spaces and assing to var</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>fqdn</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ dig_result.stdout_lines[0] | trim}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>dig_result.stdout_lines[0] is defined</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>### Optional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;TASK 12: If no dig result, assign placeholder fqdn value&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>### If no reverse DNS, then set a inventory hostname and IP as the hostname</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>fqdn</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ inventory_hostname }}-no-dns-{{ ansible_host }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>dig_result.stdout_lines[0] is undefined</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Add Device to NetBox&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>netbox.netbox.netbox_device</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>netbox_url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ netbox_url }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>netbox_token</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ netbox_token }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ fqdn }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>device_type</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_facts[&#39;net_model&#39;] }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ platform }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>serial</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_facts[&#39;net_serialnum&#39;] }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>site</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ site }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>device_role</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ device_role }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>custom_fields</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>code_version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ net_version }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>validate_certs</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Add a new Interface called management_interface to device&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>### this interface will be used as the primary IP and interface for the device</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>netbox.netbox.netbox_device_interface</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>netbox_url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ netbox_url }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>netbox_token</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ netbox_token }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>device</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ fqdn }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Management_Interface</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>other</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>validate_certs</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Add IP address of ansible host to IPAM&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>netbox.netbox.netbox_ip_address</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>netbox_url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ netbox_url }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>netbox_token</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ netbox_token }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>family</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_host }}/32&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=l>active</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>assigned_object</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Management_Interface</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>device</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ fqdn }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>validate_certs</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Assign ansible_host IP as the primary interface for the device&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>netbox.netbox.netbox_device</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>netbox_url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ netbox_url }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>netbox_token</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ netbox_token }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ fqdn }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>device_type</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_facts[&#39;net_model&#39;] }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>platform</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ platform }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>serial</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_facts[&#39;net_serialnum&#39;] }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=l>Active</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>primary_ip4</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_host }}/32&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>validate_certs</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span></code></pre></div><h2 id=the-process>The Process</h2><p>Let&rsquo;s go through the step by step.</p><p>The example below will use Juniper Devices. Junos provides some key features to help with automation:</p><ul><li>Configuration Structure (versioning, commit confirm, rollback options are super valuable)</li><li>Ability to load configuration as text blocks with replace, override and merge options</li><li>Return JSON values (i.e. Display JSON)</li></ul><h3 id=building-static-inventory-file>Building Static Inventory File</h3><p><strong>Bootstrap Inventory</strong> &ndash;> <a class=link href=https://github.com/kaon1/ansible-misc/blob/main/netbox-ansible-populate/bootstrap_inventory.ini target=_blank rel=noopener>bootstrap_inventory.ini</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[junosinv]</span>
</span></span><span class=line><span class=cl><span class=na>switch1 ansible_host</span><span class=o>=</span><span class=s>10.10.10.1</span>
</span></span><span class=line><span class=cl><span class=na>switch2 ansible_host</span><span class=o>=</span><span class=s>10.10.10.2</span>
</span></span><span class=line><span class=cl><span class=na>switch3 ansible_host</span><span class=o>=</span><span class=s>10.10.10.3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[junosinv:vars]</span>
</span></span><span class=line><span class=cl><span class=na>ansible_connection</span><span class=o>=</span><span class=s>netconf</span>
</span></span><span class=line><span class=cl><span class=na>ansible_network_os</span><span class=o>=</span><span class=s>junos  </span>
</span></span></code></pre></div><h3 id=running-the-bootstrap-playbook>Running the bootstrap playbook</h3><p>Now that we have a basic inventory. We can run the above <strong>Bootstrap Playbook</strong> &ndash;> <a class=link href=https://github.com/kaon1/ansible-misc/blob/main/netbox-ansible-populate/netbox-ansible-junos-bootstrap.yml target=_blank rel=noopener>netbox-ansible-junos-bootstrap.yml</a></p><p>The playbook will do the following:</p><ul><li>Connect to the remote juniper host and gather system facts</li><li>Connect to the Netbox server and add a new device with the below data:<ul><li>name</li><li>device_type (model)</li><li>platform (OS)</li><li>Serial Number</li><li>Site</li><li>Device role</li><li>Code Version</li></ul></li><li>Creates a new Netbox IP Address (IPAM) entry with the ansible_host IP</li><li>Creates a new interface for the device named &ldquo;management_interface&rdquo;</li><li>Assigns the IP address to the device&rsquo;s management_interface</li></ul><p><strong>Ansible Result:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>(venv) [root]# ansible-playbook -i bootstrap_inventory.ini netbox-ansible-junos-bootstrap.yml </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>PLAY [PB to Bootstrap Netbox Inventory] ******</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>[WARNING]</span><span class=p>:</span><span class=w> </span><span class=l>Ignoring timeout(10) for junos_facts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [Gathering Facts] ***********************</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>[WARNING]</span><span class=p>:</span><span class=w> </span><span class=l>default value for `gather_subset` will be changed to `min` from `!config` v2.11 onwards</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>switch1]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [Assign net version] ********************</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>switch1]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [Resolve FQDN Hostname - perform DIG] ***</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>changed</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>switch1 -&gt; localhost]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>TASK [TASK 11</span><span class=p>:</span><span class=w> </span><span class=l>Assign dig result to fqdn var] *</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ok</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>switch1]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [Add Device to NetBox] *****************</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>changed</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>switch1 -&gt; localhost]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [Add a new Interface called management_interface to device] *</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>changed</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>switch1 -&gt; localhost]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [Add IP address of ansible host to IPAM] ******</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>changed</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>switch1 -&gt; localhost]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>TASK [Assign ansible_host IP as the primary interface for the device] *</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>changed</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>switch1 -&gt; localhost]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>PLAY RECAP **************************************</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>switch1                    </span><span class=p>:</span><span class=w> </span><span class=l>ok=8    changed=5    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><span class=w>
</span></span></span></code></pre></div><p><strong>Netbox Result:</strong></p><p><img src=/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/ss1.PNG width=1590 height=267 srcset="/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/ss1_hu5bf6a70ede0e860dc5cfb546d7899dce_25735_480x0_resize_box_3.PNG 480w, /p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/ss1_hu5bf6a70ede0e860dc5cfb546d7899dce_25735_1024x0_resize_box_3.PNG 1024w" loading=lazy class=gallery-image data-flex-grow=595 data-flex-basis=1429px></p><p><img src=/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/ss2.PNG width=1632 height=802 srcset="/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/ss2_hub11c0a0400fe087e85716ebace3aed34_56585_480x0_resize_box_3.PNG 480w, /p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/ss2_hub11c0a0400fe087e85716ebace3aed34_56585_1024x0_resize_box_3.PNG 1024w" loading=lazy class=gallery-image data-flex-grow=203 data-flex-basis=488px></p><p><img src=/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/ss3.PNG width=1654 height=527 srcset="/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/ss3_hufd8a233eec9c7b19d1b2fc59abac314b_42538_480x0_resize_box_3.PNG 480w, /p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/ss3_hufd8a233eec9c7b19d1b2fc59abac314b_42538_1024x0_resize_box_3.PNG 1024w" loading=lazy class=gallery-image data-flex-grow=313 data-flex-basis=753px></p><h3 id=dynamic-inventory>Dynamic Inventory</h3><p>Now that we have populated Netbox, we can use Netbox as our <strong>ansible inventory</strong></p><p>The Netbox <a class=link href=https://docs.ansible.com/ansible/latest/collections/netbox/netbox/nb_inventory_inventory.html target=_blank rel=noopener>Dynamic Inventory Plugin</a>
can be used by creating an inventory file as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>## Ansible Plugin file for dynamic inventory through netbox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>plugin</span><span class=p>:</span><span class=w> </span><span class=l>netbox.netbox.nb_inventory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>api_endpoint</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># token: &#34;{{ lookup(&#39;env&#39;,&#39;NETBOX_API_KEY&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>validate_certs</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>config_context</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>compose</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>ansible_network_os</span><span class=p>:</span><span class=w> </span><span class=l>platform.slug</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>ansible_connection</span><span class=p>:</span><span class=w> </span><span class=l>custom_fields.ansible_connection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>device_query_filters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>status</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;active&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;some_tag&#39;</span><span class=w>
</span></span></span></code></pre></div><p>To check if dynamic inventory is working, run <strong>ansible-inventory</strong>:</p><p><code># ansible-inventory -i ../netbox/netbox_inventory.yml --host TEST01</code></p><p><strong>Result:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ansible_connection&#34;</span><span class=p>:</span> <span class=s2>&#34;netconf&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ansible_host&#34;</span><span class=p>:</span> <span class=s2>&#34;10.X.X.X&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ansible_network_os&#34;</span><span class=p>:</span> <span class=s2>&#34;junos&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;custom_fields&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;ansible_connection&#34;</span><span class=p>:</span> <span class=s2>&#34;netconf&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;code_version&#34;</span><span class=p>:</span> <span class=s2>&#34;20&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;device_roles&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;access_switch&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;device_site&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;device_types&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ex4300-48p&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;is_virtual&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;local_context_data&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=kc>null</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;locations&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;manufacturers&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;juniper&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;platforms&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;junos&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;primary_ip4&#34;</span><span class=p>:</span> <span class=s2>&#34;10.x.x.x&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;regions&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;americas&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;services&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;sites&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;xxx&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;Active&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;active&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=schedule-playbook-to-maintain-system-state>Schedule Playbook to Maintain System State</h3><p>Let&rsquo;s regularly run a <a class=link href=https://github.com/kaon1/ansible-misc/blob/main/netbox-ansible-populate/dynamic/autopop_junos_facts.yml target=_blank rel=noopener>modified version</a>
of the bootstrap playbook to maintain network state.</p><p>Modified snippet:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;CONFIRM DEVICE TO NETBOX&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>netbox.netbox.netbox_device</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>netbox_url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ netbox_url }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>netbox_token</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ netbox_token }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ inventory_hostname }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>device_type</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_facts[&#39;net_model&#39;] }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>serial</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ansible_facts[&#39;net_serialnum&#39;] }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>custom_fields</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>code_version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ net_version }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ansible_connection</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ custom_fields[&#39;ansible_connection&#39;] }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>validate_certs</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span></code></pre></div><p>The above task will only make changes to Netbox if something changes on the field device, such as the:</p><ul><li>Model number</li><li>OS version</li><li>Serial number</li></ul><p>Use <a class=link href=https://github.com/ansible/awx target=_blank rel=noopener>Ansible Tower/AWX</a> to schedule playbook execution daily, weekly or monthly.</p><h2 id=wrap-up>Wrap Up</h2><p>I hope this guide was helpful in understanding how we can use a Source of truth to dynamically populate an Ansible Inventory.
Feel free to comment below with any questions.</p></section><footer class=article-footer></footer></article><aside class=related-contents--wrapper><h2 class=section-title>Related contents</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/p/golden-configuration-deployment-with-ansible-and-netbox/><div class=article-image><img src=/p/golden-configuration-deployment-with-ansible-and-netbox/golden-config-front.0a95a4dbc7df190c14802b057fde04f9_hu3972f5f5b3bf12cabffe22f75756d981_1247419_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Golden Configuration Deployment with Ansible and Netbox" data-hash="md5-CpWk28ffGQwUgCsFf94E+Q=="></div><div class=article-details><h2 class=article-title>Golden Configuration Deployment with Ansible and Netbox</h2></div></a></article><article class=has-image><a href=/p/slack-ipam-helper/><div class=article-image><img src=/p/slack-ipam-helper/images/ipam-helper-front.059c631bacc91c912d4cb0a7cbb4037f_hu0b4c396984346b48c89ef05d3f4ab66d_78125_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Slack IPAM Helper" data-hash="md5-BZxjG6zJHJEtTLCny7QDfw=="></div><div class=article-details><h2 class=article-title>Slack IPAM Helper</h2></div></a></article><article class=has-image><a href=/p/perimeter-scanner/><div class=article-image><img src=/p/perimeter-scanner/images/_huda0cd6a7d1bad9baa374d7c905f6581c_150841_cee306edb530dd7aacf110c4b122eae5.png width=250 height=150 loading=lazy alt="Featured image of post Perimeter Scanner" data-hash="md5-Fer5VqTVcgkOKzCypd0HjQ=="></div><div class=article-details><h2 class=article-title>Perimeter Scanner</h2></div></a></article><article class=has-image><a href=/p/ansible-configuration-backup-manager/><div class=article-image><img src=/p/ansible-configuration-backup-manager/_hu12225e3f406182c91634608ad7cb2c64_1239508_1af7a87b45fb3b73a9c1c716fe9eb0f9.png width=250 height=150 loading=lazy alt="Featured image of post Ansible Configuration Backup Manager" data-hash="md5-+TQ8PJ8mkUygm6V0xYsxfQ=="></div><div class=article-details><h2 class=article-title>Ansible Configuration Backup Manager</h2></div></a></article><article class=has-image><a href=/p/self-service-containerlab-deployment-with-ansible-tower/><div class=article-image><img src=/p/self-service-containerlab-deployment-with-ansible-tower/images/clab-ansible.ba505db6de1ab9014b43ae3976868a7e_hu900e690d7d00d8033c3afbeaf3ab65f6_51076_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Self-Service ContainerLab Deployment with Ansible Tower" data-hash="md5-ulBdtt4auQFLQ645doaKfg=="></div><div class=article-details><h2 class=article-title>Self-Service ContainerLab Deployment with Ansible Tower</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//kaonbytes-com.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2022 -
2023 KaonBytes</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#the-chicken-or-the-egg-problem>The Chicken or the Egg Problem</a><ol><li><a href=#the-solution>The Solution</a></li><li><a href=#diagram>Diagram</a></li><li><a href=#the-code>The Code</a></li></ol></li><li><a href=#the-process>The Process</a><ol><li><a href=#building-static-inventory-file>Building Static Inventory File</a></li><li><a href=#running-the-bootstrap-playbook>Running the bootstrap playbook</a></li><li><a href=#dynamic-inventory>Dynamic Inventory</a></li><li><a href=#schedule-playbook-to-maintain-system-state>Schedule Playbook to Maintain System State</a></li></ol></li><li><a href=#wrap-up>Wrap Up</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>