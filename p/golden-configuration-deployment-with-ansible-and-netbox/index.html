<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Enforce intended network state using ansible and a rendered golden configuration template"><title>Golden Configuration Deployment with Ansible and Netbox</title><link rel=canonical href=https://kaonbytes.com/p/golden-configuration-deployment-with-ansible-and-netbox/><link rel=stylesheet href=/scss/style.min.450926226e724574a6b936335ea06111f8aeb253d932c86cb2cc807341cd2889.css><meta property="og:title" content="Golden Configuration Deployment with Ansible and Netbox"><meta property="og:description" content="Enforce intended network state using ansible and a rendered golden configuration template"><meta property="og:url" content="https://kaonbytes.com/p/golden-configuration-deployment-with-ansible-and-netbox/"><meta property="og:site_name" content="KaonBytes"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2022-11-01T00:00:00+00:00"><meta property="article:modified_time" content="2022-11-01T00:00:00+00:00"><meta property="og:image" content="https://kaonbytes.com/p/golden-configuration-deployment-with-ansible-and-netbox/golden-config-front.png"><meta name=twitter:site content="@kaon_123"><meta name=twitter:creator content="@kaon_123"><meta name=twitter:title content="Golden Configuration Deployment with Ansible and Netbox"><meta name=twitter:description content="Enforce intended network state using ansible and a rendered golden configuration template"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kaonbytes.com/p/golden-configuration-deployment-with-ansible-and-netbox/golden-config-front.png"><link rel="shortcut icon" href=favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-LE0JVZ0N09"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LE0JVZ0N09",{anonymize_ip:!1})}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/smaller-profile-pic_hu54d8bdb5b5178e1b011da5186eca7300_1998427_300x0_resize_box_3.png width=300 height=298 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>KaonBytes</a></h1><h2 class=site-description>Welcome to my technical blog on all things Networking, Security and Automation</h2></div></header><ol class=social-menu><li><a href=https://github.com/kaon1 target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/kaon1/ target=_blank title=LinkedIn><svg role="img" xmlns="http://www.w3.org/2000/svg" width="1e3mm" height="1e3mm" viewBox="0 0 1e3 1e3" style="max-width:1.6em;height:auto"><path id="path" style="opacity:1;vector-effect:none;fill:#000;fill-opacity:1" d="M336 332s0 457 0 457-125 0-125 0 0-457 0-457 125 0 125 0m10-126s0 0 0 0c0 41-33 74-73 74s-72-33-72-74c0-40 32-73 72-73s73 33 73 73M834 508s0 281 0 281-125 0-125 0 0-233 0-233c0-140-166-129-166 0V789s-124 0-124 0 0-457 0-457 124 0 124 0 0 74 0 74c58-108 291-116 291 102"/></svg></a></li><li><a href=https://twitter.com/kaonthana target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/golden-configuration-deployment-with-ansible-and-netbox/><img src=/p/golden-configuration-deployment-with-ansible-and-netbox/golden-config-front_hu3972f5f5b3bf12cabffe22f75756d981_1247419_800x0_resize_box_3.png srcset="/p/golden-configuration-deployment-with-ansible-and-netbox/golden-config-front_hu3972f5f5b3bf12cabffe22f75756d981_1247419_800x0_resize_box_3.png 800w, /p/golden-configuration-deployment-with-ansible-and-netbox/golden-config-front_hu3972f5f5b3bf12cabffe22f75756d981_1247419_1600x0_resize_box_3.png 1600w" width=800 height=271 loading=lazy alt="Featured image of post Golden Configuration Deployment with Ansible and Netbox"></a></div><div class=article-details><header class=article-category><a href=/categories/ansible/>ansible</a>
<a href=/categories/automation/>automation</a>
<a href=/categories/netbox/>netbox</a>
<a href=/categories/juniper/>juniper</a>
<a href=/categories/netdevops/>netdevops</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/golden-configuration-deployment-with-ansible-and-netbox/>Golden Configuration Deployment with Ansible and Netbox</a></h2><h3 class=article-subtitle>Enforce intended network state using ansible and a rendered golden configuration template</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Nov 01, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>14 minute read</time></div></footer></div></header><section class=article-content><p><strong>The first step in creating a self-healing network</strong> is to implement a golden configuration standard. Ensuring that your network devices are in compliance with intended parameters improves operational overhead, limits security risks and potential outages caused by human error.</p><p>However, this is a <strong>complex</strong> problem to solve because a universal one-size-fits-all configuration is not common. Many factors cause slight changes in configurations such as:</p><ul><li>device hardware</li><li>firmware</li><li>region specific parameters</li><li>non-idempotent secret keys</li></ul><p>&mldr; just to name a few. So how can we do it?</p><h2 id=purpose>Purpose</h2><p>In this blog post, I will share a technical architecture that I have deployed in <strong>production</strong> on hundreds of network nodes accross dozens of sites and global regions.</p><h3 id=the-steps>The Steps</h3><ol><li>Populate <strong>Source of Truth (Netbox)</strong> with desired configuration context to be loaded as dynamic inventory host variables<ul><li>Use weighted config context to populate region or site wide specific configuration</li><li>Use custom fields to populate device specific configuration (if needed)</li></ul></li><li>Populate <strong>Secret Passwords</strong> in Ansible Automation Platform Credentials library, Ansible Vault, HashiCorp Vault or some other secure method to be called later</li><li>Build custom python module to <strong>create idempotent secret keys</strong> per host.<ul><li>Securely encrypted keys which can be re-produced on each host (i.e not change on every run)</li></ul></li><li>Render intended confgiurations with Ansible <strong>Jinja2 Templating</strong></li><li><strong>Deploy</strong> desired configuration with Ansible<ul><li>In this case, we are deploying on Juniper Devices using the junos_config module with the <strong>replace</strong> argument</li></ul></li><li>Use the junos_config option <strong>commit_check</strong> to perform Compliance Checking. i.e. Dry Run of changes to be made</li></ol><p><img src=/p/golden-configuration-deployment-with-ansible-and-netbox/golden-config-flow.png width=7043 height=9961 srcset="/p/golden-configuration-deployment-with-ansible-and-netbox/golden-config-flow_hu8c00e4bf5d0b8d2a458616fc1feb32a2_2730810_480x0_resize_box_3.png 480w, /p/golden-configuration-deployment-with-ansible-and-netbox/golden-config-flow_hu8c00e4bf5d0b8d2a458616fc1feb32a2_2730810_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=70 data-flex-basis=169px></p><h2 id=the-end-result>The End Result</h2><h3 id=the-code>The Code</h3><p>Github Repo can be found here - <a class=link href=https://github.com/kaon1/golden-config-engine target=_blank rel=noopener>Golden Config Compliance Engine</a></p><p><a class=link href=https://github.com/kaon1/golden-config-engine/blob/main/junos-golden-config-template.j2 target=_blank rel=noopener>The Juniper Configuration Template</a></p><p><a class=link href=https://github.com/kaon1/golden-config-engine/blob/main/junos-golden-config-engine.yml target=_blank rel=noopener>The Ansible Playbook</a></p><h3 id=running-the-playbook>Running the playbook</h3><p>Example of <strong>out-of-compliance</strong> run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>(</span>py38env_ansible<span class=o>)</span> <span class=o>[</span>root@net config-templates<span class=o>]</span><span class=c1># ansible-playbook -i netbox_inventory.yml --e &#34;@extra-vars.yml&#34; --diff junos-golden-config-engine.yml -u kaon -k</span>
</span></span><span class=line><span class=cl>SSH password: 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PLAY <span class=o>[</span>Standardize System Params on Junos Config<span class=o>]</span> ***
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>Lookup Timezone Info by Device Site<span class=o>]</span> ***
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01 -&gt; localhost<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>Set Time Zone Fact to be used in jinja2 template<span class=o>]</span> ***
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>Grab switch software fw version from Netbox and <span class=nb>set</span> as integer Value<span class=o>]</span> ***
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>get snmp info<span class=o>]</span> ***
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>parse snmp engine id<span class=o>]</span> ***
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>generate snmp_9key<span class=o>]</span> ***
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>generate tacacs_key<span class=o>]</span> ***
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>generate root login key per device<span class=o>]</span> ***
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>Template Lookup and Config Generation<span class=o>]</span> ***
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01 -&gt; localhost<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>Load Standard System Parameters to Juniper Device<span class=o>]</span> ***
</span></span><span class=line><span class=cl><span class=o>[</span>edit system login<span class=o>]</span>
</span></span><span class=line><span class=cl>-    user bob-super-admin <span class=o>{</span>
</span></span><span class=line><span class=cl>-        uid 2006<span class=p>;</span>
</span></span><span class=line><span class=cl>-        class super-user<span class=p>;</span>
</span></span><span class=line><span class=cl>-        authentication <span class=o>{</span>
</span></span><span class=line><span class=cl>-            encrypted-password <span class=s2>&#34;</span><span class=nv>$6$Hyk9Ve</span><span class=s2>....&#34;</span><span class=p>;</span> <span class=c1>## SECRET-DATA</span>
</span></span><span class=line><span class=cl>-        <span class=o>}</span>
</span></span><span class=line><span class=cl>-    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>[</span>edit system services ssh<span class=o>]</span>
</span></span><span class=line><span class=cl>-    root-login allow<span class=p>;</span>
</span></span><span class=line><span class=cl>+    root-login deny<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>edit system<span class=o>]</span>
</span></span><span class=line><span class=cl>+   processes <span class=o>{</span>
</span></span><span class=line><span class=cl>+       web-management disable<span class=p>;</span>
</span></span><span class=line><span class=cl>+   <span class=o>}</span>
</span></span><span class=line><span class=cl>changed: <span class=o>[</span>TEST01<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>debug<span class=o>]</span> ***
</span></span><span class=line><span class=cl>fatal: <span class=o>[</span>TEST01<span class=o>]</span>: FAILED! <span class=o>=</span>&gt; <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;msg&#34;</span>: <span class=s2>&#34;Change detected, action needed&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PLAY RECAP ***
</span></span><span class=line><span class=cl>TEST01         : <span class=nv>ok</span><span class=o>=</span><span class=m>10</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>1</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>1</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>1</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>   
</span></span></code></pre></div><p>Example of <strong>in-compliance</strong> run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>(</span>py38env_ansible<span class=o>)</span> <span class=o>[</span>root@net config-templates<span class=o>]</span><span class=c1># ansible-playbook -i netbox_inventory.yml --e &#34;@extra-vars.yml&#34; --diff junos-golden-config-engine.yml -u kaon -k</span>
</span></span><span class=line><span class=cl>SSH password: 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PLAY <span class=o>[</span>Standardize System Params on Junos Config<span class=o>]</span> ***
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>Lookup Timezone Info by Device Site<span class=o>]</span> ***
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01 -&gt; localhost<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>Set Time Zone Fact to be used in jinja2 template<span class=o>]</span> ***
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>Grab switch software fw version from Netbox and <span class=nb>set</span> as integer Value<span class=o>]</span> ***
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>get snmp info<span class=o>]</span> ****
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>parse snmp engine id<span class=o>]</span> ***
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>generate snmp_9key<span class=o>]</span> ***
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>generate tacacs_key<span class=o>]</span> ***
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>generate root login key per device<span class=o>]</span> ***
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>Template Lookup and Config Generation<span class=o>]</span> ***
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01 -&gt; localhost<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>TASK <span class=o>[</span>Load Standard System Parameters to Juniper Device<span class=o>]</span> ***
</span></span><span class=line><span class=cl>ok: <span class=o>[</span>TEST01<span class=o>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PLAY RECAP ***
</span></span><span class=line><span class=cl>TTEST01         : <span class=nv>ok</span><span class=o>=</span><span class=m>10</span>   <span class=nv>changed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>2</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>   
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>(</span>py38env_ansible<span class=o>)</span> <span class=o>[</span>root@server config-templates<span class=o>]</span><span class=c1># </span>
</span></span></code></pre></div><h2 id=the-nuts-and-bolts-how-to>The Nuts and Bolts How-To</h2><h3 id=declaring-intended-state>Declaring Intended State</h3><p>In order to build a golden configuration we have to start <em>somewhere</em>. In this tutorial we are using <strong>Juniper Junos</strong> devices.
Junos devices facilitate automation because:</p><ul><li>They offer the ability to load all or parts of configuration as <strong>hierarchical text</strong>.</li><li>Allows for <strong>replace functionality</strong> in which the operating system determines configuration differences and inserts/deletes lines as needed</li><li>Has the ability to <strong>check commit</strong> which performs a dry run load of the intended configuration without making the change</li></ul><p>A simple Junos Configuration .txt file could look something like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>replace:
</span></span><span class=line><span class=cl>system <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    host-name &lt;some_name&gt;<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    services <span class=o>{</span>
</span></span><span class=line><span class=cl>        ssh <span class=o>{</span>
</span></span><span class=line><span class=cl>		&lt;some_more config&gt;
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    time-zone &lt;some_tz&gt;<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    name-server <span class=o>{</span>
</span></span><span class=line><span class=cl>		&lt;some_ns1&gt;
</span></span><span class=line><span class=cl>		&lt;some_ns2&gt;
</span></span><span class=line><span class=cl>		&lt;some_ns3&gt;
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    syslog <span class=o>{</span>
</span></span><span class=line><span class=cl>		&lt;some_more config&gt;
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    ntp <span class=o>{</span>
</span></span><span class=line><span class=cl>		&lt;some_server1&gt;
</span></span><span class=line><span class=cl>		&lt;some_server2&gt;
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    login <span class=o>{</span>
</span></span><span class=line><span class=cl>		&lt;some_user_config&gt;
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>replace:
</span></span><span class=line><span class=cl>snmp <span class=o>{</span>
</span></span><span class=line><span class=cl>    description &lt;some_description&gt;<span class=p>;</span>
</span></span><span class=line><span class=cl>    location &lt;some_location&gt;<span class=p>;</span>
</span></span><span class=line><span class=cl>    contact &lt;some_email&gt;<span class=p>;</span>
</span></span><span class=line><span class=cl>    v3 <span class=o>{</span>
</span></span><span class=line><span class=cl>		&lt;some_more config&gt;
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>&lt;some_more config&gt;
</span></span></code></pre></div><p>If we manually populate all the above values with correct Junos syntax and load it via the CLI then the OS will replace the <strong>system</strong> section and <strong>snmp</strong> section with the declared .txt file.</p><p>But how can we turn the above snippet into a golden config to apply across multiple devices?</p><h3 id=source-of-truth---netbox>Source Of Truth - Netbox</h3><p>First we need to model our devices into a centralized location. <a class=link href=https://github.com/netbox-community/netbox target=_blank rel=noopener>Netbox</a> is a good tool to use for this, but other products also exist such as Nautobot, Solarwinds, InfoBlox etc</p><p>In a <a class=link href=http://localhost:1313/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/ target=_blank rel=noopener>previous blog post</a> I discussed how we can use Netbox as our dynamic Ansible inventory. When we populate our Ansible Inventory from Netbox, we can also pull in important <strong>host variables</strong>. These variables can be used to populate our Juniper System Configuration text file.</p><p>Example of Ansible hostvars from Netbox inventory:</p><p><code># ansible-inventory -i ../netbox/netbox_inventory.yml --host TEST01</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ansible_connection&#34;</span><span class=p>:</span> <span class=s2>&#34;netconf&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ansible_host&#34;</span><span class=p>:</span> <span class=s2>&#34;10.X.X.X&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ansible_network_os&#34;</span><span class=p>:</span> <span class=s2>&#34;junos&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;custom_fields&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;ansible_connection&#34;</span><span class=p>:</span> <span class=s2>&#34;netconf&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;code_version&#34;</span><span class=p>:</span> <span class=s2>&#34;20&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;device_roles&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;access_switch&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;device_site&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;device_types&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ex4300-48p&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;is_virtual&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;local_context_data&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=kc>null</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;locations&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;manufacturers&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;juniper&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;platforms&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;junos&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;primary_ip4&#34;</span><span class=p>:</span> <span class=s2>&#34;10.x.x.x&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;regions&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;americas&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;services&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;sites&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;xxx&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;label&#34;</span><span class=p>:</span> <span class=s2>&#34;Active&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;active&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=config-context>Config Context</h3><p>In addition to device specific variables, we can render large blocks of configuration with the <a class=link href=https://docs.netbox.dev/en/stable/features/context-data/ target=_blank rel=noopener>Context Data</a> feature of Netbox.
Context data can be applied to a class of devices on different conditions such as site, region, role, etc</p><ul><li>For example, all switches in Europe should use an EU set of NTP servers</li></ul><p>Weighting can be used to apply multiple layers of context data.</p><ul><li>For example, all devices should use DNS server 10.10.10.10 (default weight of 1000)</li><li>However, devices in SITE A should use DNS server 11.11.11.11 (set weight 2000)</li></ul><p><strong>Example Config Context Declaration:</strong></p><p><img src=/p/golden-configuration-deployment-with-ansible-and-netbox/nb-config-context5.png width=1881 height=953 srcset="/p/golden-configuration-deployment-with-ansible-and-netbox/nb-config-context5_hu4e1bbcd0cbd1c7dd0bfd68eb460664dc_100926_480x0_resize_box_3.png 480w, /p/golden-configuration-deployment-with-ansible-and-netbox/nb-config-context5_hu4e1bbcd0cbd1c7dd0bfd68eb460664dc_100926_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=197 data-flex-basis=473px></p><p><strong>Example of Rendered Content Per Device:</strong></p><p><img src=/p/golden-configuration-deployment-with-ansible-and-netbox/nb-config-context6.png width=1576 height=910 srcset="/p/golden-configuration-deployment-with-ansible-and-netbox/nb-config-context6_hu15abef954ed4b204f3b3cdcbad3b5d1a_60957_480x0_resize_box_3.png 480w, /p/golden-configuration-deployment-with-ansible-and-netbox/nb-config-context6_hu15abef954ed4b204f3b3cdcbad3b5d1a_60957_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=173 data-flex-basis=415px></p><p>In the above screenshot, we have populated the following parameters for this individual device:</p><ul><li>Domain Name</li><li>Name Servers</li><li>NTP Servers</li><li>TACACS Servers</li></ul><p>The rendered config can now be sent to the Ansible Inventory as variable called <code>hostvars[inventory_hostname]['config_context']</code></p><h3 id=handling-credentials-and-secret-passwords>Handling Credentials And Secret Passwords</h3><p>Do <strong>not</strong> commit secret keys to github :)</p><p>Instead, let&rsquo;s inject our passwords as credentials in <a class=link href=https://docs.ansible.com/automation-controller/4.0.0/html/userguide/credentials.html target=_blank rel=noopener>Ansible Automation Platform</a> and call them as variables during runtime execution. As an alternative, we can also do this with <a class=link href=https://www.vaultproject.io/ target=_blank rel=noopener>Hashicorp Vault</a> using the hashi_vault lookup module.</p><p><strong>Example Passwords to Store:</strong></p><p><img src=/p/golden-configuration-deployment-with-ansible-and-netbox/aap1.png width=1428 height=779 srcset="/p/golden-configuration-deployment-with-ansible-and-netbox/aap1_hue70311129c583ca328e5f1fa7f6218e2_67502_480x0_resize_box_3.png 480w, /p/golden-configuration-deployment-with-ansible-and-netbox/aap1_hue70311129c583ca328e5f1fa7f6218e2_67502_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=183 data-flex-basis=439px></p><p><strong>Example of injecting passwords into your playbook build:</strong></p><p><img src=/p/golden-configuration-deployment-with-ansible-and-netbox/aap2.png width=1680 height=976 srcset="/p/golden-configuration-deployment-with-ansible-and-netbox/aap2_huf7cc1edf93601f2adcb5160754a40b21_83572_480x0_resize_box_3.png 480w, /p/golden-configuration-deployment-with-ansible-and-netbox/aap2_huf7cc1edf93601f2adcb5160754a40b21_83572_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=172 data-flex-basis=413px></p><p>Passwords can be called as variables inside your playbook. The variable name is determined by the credential_type that was created earlier. For example, the snmp credential type passes a variable called <code>snmp_cred</code> which can be referenced as such:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># lookup secrets from ansible credentials</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tacacs_pw</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ tacacs_pw }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>root_pw</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ root_pw }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>snmp_cred</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ snmp_cred }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ssh_key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ ssh_key }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><h4 id=creating-idempotent-secret-keys-from-passwords>Creating Idempotent Secret Keys from Passwords</h4><p>We <em>could</em> load these secrets directly into our Jinja2 template. Junos would accept the rendered configuration and internally convert the passwords to encrypted keys in its running configuration. However, if we did this, then each subsequent run would register a <strong>change</strong> (i.e. not idempotent)</p><p>Here&rsquo;s how we can solve this problem:</p><p><strong>The $9$ Key</strong></p><ul><li>Juniper uses <strong>$9$ encoded keys</strong> (similar to cisco type 7) for shared secrets which run on services such as BGP, TACACS and SNMP. The user inputs a plain text password and the OS obfuscates it, when needed the OS is able to decrypt the key.</li><li>Simple, lets find a python library that encodes the $9$ algorithm, input our snmpv3 plaintext password and call it a day. WRONG :( unfortunately, the OS accepts the key but snmpv3 authentication breaks:</li></ul><p><img src=/p/golden-configuration-deployment-with-ansible-and-netbox/9key1.jfif width=2048 height=818 srcset="/p/golden-configuration-deployment-with-ansible-and-netbox/9key1_huf954a054afc492fa289e92c5fb7d03c7_96711_480x0_resize_q75_box.jfif 480w, /p/golden-configuration-deployment-with-ansible-and-netbox/9key1_huf954a054afc492fa289e92c5fb7d03c7_96711_1024x0_resize_q75_box.jfif 1024w" loading=lazy class=gallery-image data-flex-grow=250 data-flex-basis=600px></p><ul><li>RFC3414 describes how snmpv3 creates a localized unique key per device. We need to hash the local engine ID + password + other. The below C code is provided as an example in the RFC. Luckily there&rsquo;s a python library for that&mldr;</li></ul><p><img src=/p/golden-configuration-deployment-with-ansible-and-netbox/9key2.jfif width=1514 height=2308 srcset="/p/golden-configuration-deployment-with-ansible-and-netbox/9key2_huea75e9bd78ebded03bcac91be35847d5_258473_480x0_resize_q75_box.jfif 480w, /p/golden-configuration-deployment-with-ansible-and-netbox/9key2_huea75e9bd78ebded03bcac91be35847d5_258473_1024x0_resize_q75_box.jfif 1024w" loading=lazy class=gallery-image data-flex-grow=65 data-flex-basis=157px></p><ul><li>The snmpv3_hashgen library takes the input of your plain text pw + your engineID and outputs a key. Great, lets take this key and put it in our $9$ function. so localized key &ndash;> $9$ function = $9$&mldr;key to be used for junos config.</li></ul><p><img src=/p/golden-configuration-deployment-with-ansible-and-netbox/9key3.jfif width=1902 height=1080 srcset="/p/golden-configuration-deployment-with-ansible-and-netbox/9key3_hu6485f23e60e2e8e9568294bae27898e8_98790_480x0_resize_q75_box.jfif 480w, /p/golden-configuration-deployment-with-ansible-and-netbox/9key3_hu6485f23e60e2e8e9568294bae27898e8_98790_1024x0_resize_q75_box.jfif 1024w" loading=lazy class=gallery-image data-flex-grow=176 data-flex-basis=422px></p><ul><li>The $9$ key is compatible and works in junos snmpv3 config block. However there&rsquo;s still a problem, the key is different every time it&rsquo;s generated. This breaks repeatability. We can fix this by setting a static salt in the $9$ generator function.</li><li>In this case, a static salt does not make us less secure because each $9$ key is already unique per device (because each localized snmp key is unique due to the engineID being different). Now we have a working process. Lets put all this into a python filter and implement it.</li></ul><p><img src=/p/golden-configuration-deployment-with-ansible-and-netbox/9key4.jfif width=2048 height=818 srcset="/p/golden-configuration-deployment-with-ansible-and-netbox/9key4_huf954a054afc492fa289e92c5fb7d03c7_89622_480x0_resize_q75_box.jfif 480w, /p/golden-configuration-deployment-with-ansible-and-netbox/9key4_huf954a054afc492fa289e92c5fb7d03c7_89622_1024x0_resize_q75_box.jfif 1024w" loading=lazy class=gallery-image data-flex-grow=250 data-flex-basis=600px></p><ul><li>Custom python filter to be imported in the ansible playbook can be <a class=link href=https://github.com/kaon1/golden-config-engine/blob/main/filter_plugins/filter.py target=_blank rel=noopener>found here</a>. Snippet of the function:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>gen_snmp_9key</span><span class=p>(</span><span class=n>engine_id</span><span class=p>,</span> <span class=n>snmp_pass</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        Takes two inputs (engine_id and snmp password).
</span></span></span><span class=line><span class=cl><span class=s2>        Hashes the password and engine id together to create a localized key.
</span></span></span><span class=line><span class=cl><span class=s2>        Then encodes the key with the juniper $9$ algorithm to be used in junos configuration
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>hash</span> <span class=o>=</span> <span class=n>Hashgen</span><span class=o>.</span><span class=n>algs</span><span class=p>[</span><span class=s2>&#34;sha1&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>Kul_auth</span> <span class=o>=</span> <span class=n>Hashgen</span><span class=o>.</span><span class=n>derive_msg</span><span class=p>(</span><span class=n>snmp_pass</span><span class=p>,</span> <span class=n>engine_id</span><span class=p>,</span> <span class=nb>hash</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>Kul_priv</span> <span class=o>=</span> <span class=n>Hashgen</span><span class=o>.</span><span class=n>derive_msg</span><span class=p>(</span><span class=n>snmp_pass</span><span class=p>,</span> <span class=n>engine_id</span><span class=p>,</span> <span class=nb>hash</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>localized_key</span> <span class=o>=</span> <span class=nb>hash</span><span class=p>(</span><span class=n>Kul_auth</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>snmp_9key</span> <span class=o>=</span> <span class=n>encrypt</span><span class=p>(</span><span class=n>localized_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>snmp_9key</span>
</span></span></code></pre></div><ul><li>Results: first run to standardize the config. Registers a change (as expected):</li></ul><p><img src=/p/golden-configuration-deployment-with-ansible-and-netbox/9key5.png width=2127 height=1090 srcset="/p/golden-configuration-deployment-with-ansible-and-netbox/9key5_hu7142a5aa952953789ba5933ad6cf2b21_83145_480x0_resize_box_3.png 480w, /p/golden-configuration-deployment-with-ansible-and-netbox/9key5_hu7142a5aa952953789ba5933ad6cf2b21_83145_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=195 data-flex-basis=468px></p><ul><li>Subsequent runs. No change. But confirms we are in compliance and standardization:</li></ul><p><img src=/p/golden-configuration-deployment-with-ansible-and-netbox/9key6.png width=2131 height=1093 srcset="/p/golden-configuration-deployment-with-ansible-and-netbox/9key6_hu57bf9b69438fc451ff661cda34512780_63513_480x0_resize_box_3.png 480w, /p/golden-configuration-deployment-with-ansible-and-netbox/9key6_hu57bf9b69438fc451ff661cda34512780_63513_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=194 data-flex-basis=467px></p><p><strong>Other $9$ Keys (Not SNMP)</strong></p><p>For other System $9$ keys (such as TACACS, RADIUS, etc). We can use the <strong>device hostname</strong> as our salt. Using the device hostname means we always generate a repeatable $9$ key per device but not the same key accross all devices.</p><p>In the same python filter, we have some modified functions here which take two inputs</p><ol><li>Device Hostname</li><li>Password</li></ol><p>and spit out an encrypted unique but repeatable $9$ key:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>## Create a unique but repeatable decimal number based on string (i.e. hostname)</span>
</span></span><span class=line><span class=cl><span class=c1>## Set range of decimal with modulo (i.e to get a number between 0 to 64 set modulo 65)</span>
</span></span><span class=line><span class=cl><span class=c1>## Example: input hostname &#39;switch-123&#39; output: 56</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_unique_decimal_from_string</span><span class=p>(</span><span class=n>str_to_hash</span><span class=p>,</span><span class=n>modulo</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>str_to_hash_hex</span> <span class=o>=</span> <span class=n>md5</span><span class=p>(</span><span class=n>str_to_hash</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf&#34;</span><span class=p>))</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>str_to_hash_dec</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>str_to_hash_hex</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>str_to_hash_dec</span> <span class=o>%</span> <span class=n>modulo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Create a unique, &#39;random&#39;, single character salt value from the string hostname. Repeatable.</span>
</span></span><span class=line><span class=cl><span class=c1>## Example: input hostname &#39;switch-123&#39; output: &#39;V&#39; (this is a character from the FAMILY structure above)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_deterministic_salt_from_hostname</span><span class=p>(</span><span class=n>hostname</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># returns a number from 0-64</span>
</span></span><span class=line><span class=cl>    <span class=n>str_to_hash_dec</span> <span class=o>=</span> <span class=n>get_unique_decimal_from_string</span><span class=p>(</span><span class=n>hostname</span><span class=p>,</span><span class=mi>65</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># calls index of list NUM_ALPHA[0-64] and returns 1 character</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>NUM_ALPHA</span><span class=p>[</span><span class=n>str_to_hash_dec</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Create a unique, &#39;random&#39;, 0-3 character bookend-salt value from the string hostname. Repeatable.</span>
</span></span><span class=line><span class=cl><span class=c1>## Example: input hostname &#39;switch-123&#39; and salt &#39;V&#39; Output &#39;9wY&#39;. </span>
</span></span><span class=line><span class=cl><span class=c1>## The length of the output is determined by the index of the salt in the EXTRA dictionary (i.e. EXTRA[salt])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_deterministic_bookend_from_hostname</span><span class=p>(</span><span class=n>hostname</span><span class=p>,</span><span class=n>salt</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>end_piece</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>count</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>EXTRA</span><span class=p>[</span><span class=n>salt</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=n>bookend_letter_dec</span> <span class=o>=</span> <span class=n>get_unique_decimal_from_string</span><span class=p>(</span><span class=n>hostname</span><span class=p>[</span><span class=n>count</span><span class=p>],</span><span class=mi>65</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>end_piece</span> <span class=o>+=</span> <span class=n>NUM_ALPHA</span><span class=p>[</span><span class=n>bookend_letter_dec</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>end_piece</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>encrypt_with_hostname</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=n>hostname</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>salt</span> <span class=o>=</span> <span class=n>get_deterministic_salt_from_hostname</span><span class=p>(</span><span class=n>hostname</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>rand</span> <span class=o>=</span> <span class=n>get_deterministic_bookend_from_hostname</span><span class=p>(</span><span class=n>hostname</span><span class=p>,</span><span class=n>salt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>position</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>previous</span> <span class=o>=</span> <span class=n>salt</span>
</span></span><span class=line><span class=cl>    <span class=n>crypted</span> <span class=o>=</span> <span class=n>MAGIC</span> <span class=o>+</span> <span class=n>salt</span> <span class=o>+</span> <span class=n>rand</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>value</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>encode</span> <span class=o>=</span> <span class=n>ENCODING</span><span class=p>[</span><span class=n>position</span> <span class=o>%</span> <span class=nb>len</span><span class=p>(</span><span class=n>ENCODING</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=n>crypted</span> <span class=o>+=</span> <span class=n>__gap_encode</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>previous</span><span class=p>,</span> <span class=n>encode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>previous</span> <span class=o>=</span> <span class=n>crypted</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>position</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>crypted</span>
</span></span></code></pre></div><p><strong>$1$ - $5$ and $6$ Keys</strong></p><p>These keys are MUCH simpler to implement. 1,5,6 keys use standard hashing algorithms.</p><ul><li>Legacy JUNOS devices use $1$ keys (Hash Algo md5)</li><li>Modern JUNOS devices use $5$ keys (sha256) or $6$ (sha512)</li></ul><p>We can use the built in ansible module <strong>password_hash</strong> to generate these keys. However, to create an idempotent key, we need to use the device hostname as the random seed. Example below:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>generate root login key per device</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>root_key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ root_pw | password_hash(hash_algo, 65534 | random(seed=inventory_hostname) | string) }}&#34;</span><span class=w>
</span></span></span></code></pre></div><p>The root password is encrypted with the sha512 algorithm + device hostname as the random seed. The resulting string is a unique but repeatable $6$ key per device.</p><h3 id=jinja2-template>Jinja2 Template</h3><p>After all that work, we have our base config, variables and secret keys ready. We can mash them all together in a jinja2 template. <a class=link href=https://github.com/kaon1/golden-config-engine/blob/main/junos-golden-config-template.j2 target=_blank rel=noopener>Here is the template</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=err>replace:</span>
</span></span><span class=line><span class=cl><span class=err>system</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>root-authentication</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>        <span class=err>encrypted-password</span> <span class=nt>&#34;{{ root_key }}&#34;</span><span class=err>;</span> <span class=err>##</span> <span class=err>SECRET-DATA</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>authentication-order</span> <span class=p>[</span> <span class=err>password</span> <span class=err>tacplus</span> <span class=p>]</span><span class=err>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>host-name</span> <span class=p>{</span><span class=err>{</span> <span class=err>inventory_hostname</span> <span class=p>}</span><span class=err>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>services</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=err>ssh</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>	    <span class=err>root-login</span> <span class=err>deny;</span>
</span></span><span class=line><span class=cl>            <span class=err>protocol-version</span> <span class=err>v2;</span>
</span></span><span class=line><span class=cl>            <span class=err>max-sessions-per-connection</span> <span class=err>32;</span>
</span></span><span class=line><span class=cl>            <span class=err>{%</span> <span class=err>if</span> <span class=err>code_version|int</span> <span class=err>&gt;=</span> <span class=err>19</span> <span class=err>%</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=err>sftp-server;</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=err>%</span> <span class=err>endif</span> <span class=err>%</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=err>}</span>
</span></span><span class=line><span class=cl>        <span class=err>netconf</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=err>ssh;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=err>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>domain-name</span> <span class=p>{</span><span class=err>{</span> <span class=err>hostvars[inventory_hostname][&#39;config_context&#39;][0][&#39;domain-name&#39;]</span> <span class=p>}</span><span class=err>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>time-zone</span> <span class=p>{</span><span class=err>{</span> <span class=err>timezone</span> <span class=p>}</span><span class=err>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>name-server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=err>{%</span> <span class=err>for</span> <span class=err>item</span> <span class=err>in</span> <span class=err>hostvars[inventory_hostname][&#39;config_context&#39;][0][&#39;name-servers&#39;]</span> <span class=err>%</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=err>{</span> <span class=err>item</span> <span class=p>}</span><span class=err>};</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span><span class=err>%</span> <span class=err>endfor</span> <span class=err>%</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=err>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>syslog</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=err>user</span> <span class=err>*</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>            <span class=err>any</span> <span class=err>emergency;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span><span class=err>%</span> <span class=err>for</span> <span class=err>item</span> <span class=err>in</span> <span class=err>hostvars[inventory_hostname][&#39;config_context&#39;][0][&#39;log-agg&#39;]</span> <span class=err>%</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=err>host</span> <span class=p>{</span><span class=err>{</span> <span class=err>item</span> <span class=p>}</span><span class=err>}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=err>any</span> <span class=err>any;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span><span class=err>%</span> <span class=err>endfor</span> <span class=err>%</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=err>file</span> <span class=err>messages</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=err>any</span> <span class=err>warning;</span>
</span></span><span class=line><span class=cl>            <span class=err>authorization</span> <span class=err>info;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=err>source-address</span> <span class=p>{</span><span class=err>{</span> <span class=err>ansible_host</span> <span class=p>}</span><span class=err>};</span>
</span></span><span class=line><span class=cl>    <span class=err>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>ntp</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=err>server</span> <span class=err>{{</span> <span class=err>hostvars[inventory_hostname][&#39;config_context&#39;][0][&#39;ntp-servers&#39;][0]</span> <span class=p>}</span><span class=err>}</span> <span class=err>prefer;</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span><span class=err>%</span> <span class=err>for</span> <span class=err>item</span> <span class=err>in</span> <span class=err>hostvars[inventory_hostname][&#39;config_context&#39;][0][&#39;ntp-servers&#39;][1:]</span> <span class=err>%</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=err>server</span> <span class=p>{</span><span class=err>{</span> <span class=err>item</span> <span class=p>}</span><span class=err>};</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span><span class=err>%</span> <span class=err>endfor</span> <span class=err>%</span><span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=err>source-address</span> <span class=p>{</span><span class=err>{</span> <span class=err>ansible_host</span> <span class=p>}</span><span class=err>};</span>
</span></span><span class=line><span class=cl>    <span class=err>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>login</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=err>user</span> <span class=err>ansible</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>            <span class=err>class</span> <span class=err>super-user;</span>
</span></span><span class=line><span class=cl>            <span class=err>authentication</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>                <span class=err>ssh-rsa</span> <span class=nt>&#34;{{ ssh_pub_key }}&#34;</span><span class=err>;</span> <span class=err>##</span> <span class=err>SECRET-DATA</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>tacplus-server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=err>{{</span> <span class=err>hostvars[inventory_hostname][&#39;config_context&#39;][0][&#39;tacplus-servers&#39;][0]</span> <span class=p>}</span><span class=err>}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=err>port</span> <span class=err>49;</span>
</span></span><span class=line><span class=cl>            <span class=err>secret</span> <span class=nt>&#34;{{ tacacs_key }}&#34;</span><span class=err>;</span> <span class=err>##</span> <span class=err>SECRET-DATA</span>
</span></span><span class=line><span class=cl>            <span class=err>source-address</span> <span class=p>{</span><span class=err>{</span> <span class=err>ansible_host</span> <span class=p>}}</span><span class=err>;</span>
</span></span><span class=line><span class=cl>        <span class=err>}</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=err>{</span> <span class=err>hostvars[inventory_hostname][&#39;config_context&#39;][0][&#39;tacplus-servers&#39;][1]</span> <span class=p>}</span><span class=err>}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=err>port</span> <span class=err>49;</span>
</span></span><span class=line><span class=cl>            <span class=err>secret</span> <span class=nt>&#34;{{ tacacs_key }}&#34;</span><span class=err>;</span> <span class=err>##</span> <span class=err>SECRET-DATA</span>
</span></span><span class=line><span class=cl>            <span class=err>source-address</span> <span class=p>{</span><span class=err>{</span> <span class=err>ansible_host</span> <span class=p>}}</span><span class=err>;</span>
</span></span><span class=line><span class=cl>        <span class=err>}</span>
</span></span><span class=line><span class=cl>    <span class=err>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=err>accounting</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=err>events</span> <span class=err>[</span> <span class=err>login</span> <span class=err>interactive-commands</span> <span class=err>];</span>
</span></span><span class=line><span class=cl>        <span class=err>destination</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>            <span class=err>tacplus</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>                <span class=err>server</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>                    <span class=err>{{</span> <span class=err>hostvars[inventory_hostname][&#39;config_context&#39;][0][&#39;tacplus-servers&#39;][0]</span> <span class=p>}</span><span class=err>}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=err>port</span> <span class=err>49;</span>
</span></span><span class=line><span class=cl>                        <span class=err>secret</span> <span class=nt>&#34;{{ tacacs_key }}&#34;</span><span class=err>;</span> <span class=err>##</span> <span class=err>SECRET-DATA</span>
</span></span><span class=line><span class=cl>                        <span class=err>timeout</span> <span class=mi>1</span><span class=err>;</span>
</span></span><span class=line><span class=cl>                        <span class=err>source-address</span> <span class=p>{</span><span class=err>{</span> <span class=err>ansible_host</span> <span class=p>}}</span><span class=err>;</span>
</span></span><span class=line><span class=cl>                    <span class=err>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span><span class=err>{</span> <span class=err>hostvars[inventory_hostname][&#39;config_context&#39;][0][&#39;tacplus-servers&#39;][1]</span> <span class=p>}</span><span class=err>}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=err>port</span> <span class=err>49;</span>
</span></span><span class=line><span class=cl>                        <span class=err>secret</span> <span class=nt>&#34;{{ tacacs_key }}&#34;</span><span class=err>;</span> <span class=err>##</span> <span class=err>SECRET-DATA</span>
</span></span><span class=line><span class=cl>                        <span class=err>timeout</span> <span class=mi>1</span><span class=err>;</span>
</span></span><span class=line><span class=cl>                        <span class=err>source-address</span> <span class=p>{</span><span class=err>{</span> <span class=err>ansible_host</span> <span class=p>}}</span><span class=err>;</span>
</span></span><span class=line><span class=cl>                    <span class=err>}</span>
</span></span><span class=line><span class=cl>                <span class=err>}</span>
</span></span><span class=line><span class=cl>            <span class=err>}</span>
</span></span><span class=line><span class=cl>        <span class=err>}</span>
</span></span><span class=line><span class=cl>    <span class=err>}</span>
</span></span><span class=line><span class=cl><span class=err>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>replace:</span>
</span></span><span class=line><span class=cl><span class=err>snmp</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=err>description</span> <span class=err>{{</span> <span class=err>inventory_hostname</span> <span class=p>}</span><span class=err>};</span>
</span></span><span class=line><span class=cl>    <span class=err>location</span> <span class=p>{</span><span class=err>{</span> <span class=err>device_site</span> <span class=p>}</span><span class=err>};</span>
</span></span><span class=line><span class=cl>    <span class=err>contact</span> <span class=s2>&#34;email@email.com&#34;</span><span class=err>;</span>
</span></span><span class=line><span class=cl>    <span class=err>v</span><span class=mi>3</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=err>usm</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>            <span class=err>local-engine</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>                <span class=err>user</span> <span class=err>usernameforsnmp</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>                    <span class=err>authentication-sha</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>                        <span class=err>authentication-key</span> <span class=nt>&#34;{{ snmp_9key }}&#34;</span><span class=err>;</span> <span class=err>##</span> <span class=err>SECRET-DATA</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=err>privacy-aes</span><span class=mi>128</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=err>privacy-key</span> <span class=nt>&#34;{{ snmp_9key }}&#34;</span><span class=err>;</span> <span class=err>##</span> <span class=err>SECRET-DATA</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=err>}</span>
</span></span><span class=line><span class=cl>            <span class=err>}</span>
</span></span><span class=line><span class=cl>        <span class=err>}</span>
</span></span><span class=line><span class=cl>        <span class=err>vacm</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=err>security-to-group</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>                <span class=err>security-model</span> <span class=err>usm</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>                    <span class=err>security-name</span> <span class=err>usernameforsnmp</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>                        <span class=err>group</span> <span class=err>groupforsnmp;</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=err>}</span>
</span></span><span class=line><span class=cl>            <span class=err>}</span>
</span></span><span class=line><span class=cl>            <span class=err>access</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=err>group</span> <span class=err>groupforsnmp</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>                    <span class=err>default-context-prefix</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>                        <span class=err>security-model</span> <span class=err>usm</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>                            <span class=err>security-level</span> <span class=err>privacy</span> <span class=err>{</span>
</span></span><span class=line><span class=cl>                                <span class=err>read-view</span> <span class=err>view-all;</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=err>}</span>
</span></span><span class=line><span class=cl>                    <span class=err>}</span>
</span></span><span class=line><span class=cl>                <span class=err>}</span>
</span></span><span class=line><span class=cl>            <span class=err>}</span>
</span></span><span class=line><span class=cl>        <span class=err>}</span>
</span></span><span class=line><span class=cl>    <span class=err>}</span>
</span></span><span class=line><span class=cl>    <span class=err>view</span> <span class=err>view-all</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=err>oid</span> <span class=err>1</span> <span class=err>include;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=err>}</span>
</span></span></code></pre></div><p>Notice the python-style logic using <strong>IF and FOR Loops</strong> above. We can use conditional logic to add/subtract configuration.</p><p>In the above example, if running Junos version 19 or greater add the <strong>sftp line</strong>.
For loops can also be used to implement multiple entries (like NTP servers).</p><p><strong>Generating Config from Template</strong></p><p>The Ansible module <strong>template</strong> can take the jinja2 text file and inject the variables to spit out a ready-to-go junos.conf file</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Template Lookup and Config Generation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># generate template of system params. Variables are filled in by Netbox (from hostvars pulled to inventory)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ template_name }}.j2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># create a temp candidate config file to be loaded in next task</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ inventory_hostname }}.conf&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># this task will always generate a change, don&#39;t need to see it.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>changed_when</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span></code></pre></div><p><strong>Loading configuration using Junos_Config module:</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Load Standard System Parameters to Juniper Device</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>junipernetworks.junos.junos_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># if TRUE this will be a DRY RUN (no changes)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>check_commit</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ check_commit }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>src_format</span><span class=p>:</span><span class=w> </span><span class=l>text</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># we use the replace flag to overwrite specific blocks of config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>update</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># temp candidate config file created in previous task</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ inventory_hostname }}.conf&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>result</span><span class=w>
</span></span></span></code></pre></div><h3 id=juniper-commit_check-feature>Juniper Commit_Check Feature</h3><p>In the above ansible task, notice the flag <code>check_commit</code>.</p><p>This is a junos-specific function that we can use to perform dry runs (when set to <strong>TRUE</strong>). During execution, we can inject the check_commit variable (True or False) to decide if our playbook should be running in enforcing mode or compliance mode.</p><h3 id=first-run-and-recurring-enforcement>First Run and Recurring Enforcement</h3><p>A potential workflow could look like this:</p><ol><li>Standardize all configurations with the initial run of changes.</li><li>Subsequent playbook runs are scheduled regularly in <code>check_commit</code> mode</li><li>If something has changed (either in the field or in the Source-of-truth) which does not match the standard then fail the playbook and send a notification.</li><li>Engineer manually assesses the situation and determines if the playbook should be run again in enforcing mode (revert the change) or update the source of truth.</li></ol><p>We can use a <em>hack</em> to fail the playbook and trigger a notification with this code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>    </span><span class=c># if running in compliance mode, error out when change is detected and action is needed to be taken. i.e alert on non-compliance</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>debug</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>msg</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Change detected, action needed&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>result.changed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>check_commit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>failed_when</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>result.changed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>check_commit</span><span class=w>
</span></span></span></code></pre></div><p>In AAP (or Ansible Tower), we can set <a class=link href=https://docs.ansible.com/ansible-tower/latest/html/userguide/notifications.html target=_blank rel=noopener>notifications</a> on failed playbooks via email, slack or other methods.</p><p>If running directly from ansible CLI yu can use <a class=link href=https://docs.ansible.com/ansible/latest/collections/index_callback.html target=_blank rel=noopener>callback plugins</a> to send notifications.</p><h2 id=final-thoughts>Final Thoughts</h2><p>Standardizing configurations across a distributed network is an essential pillar of Network Automation. I hope this guide is helpful to anyone looking for a similar solution.
My solution can be improved upon by adding more vendors to the mix (Cisco, Arista, etc) and adding additional config blocks such as BGP, Interface configurations, Prefix Maps etc&mldr;.but that&rsquo;s another post :)</p><p>If you have any questions or need clarifications feel free to leave a comment below or contact me. Thanks for reading!</p></section><footer class=article-footer></footer></article><aside class=related-contents--wrapper><h2 class=section-title>Related contents</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/><div class=article-image><img src=/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/_hu91008c89e08c35be24c68bc187db22be_244905_6b7b6c28489eabc0762e130a45e366ac.png width=250 height=150 loading=lazy alt="Featured image of post Netbox Dynamic Inventory for Ansible as a feedback loop" data-hash="md5-isvFNqFle3F1LJV2T6/Njg=="></div><div class=article-details><h2 class=article-title>Netbox Dynamic Inventory for Ansible as a feedback loop</h2></div></a></article><article class=has-image><a href=/p/ansible-configuration-backup-manager/><div class=article-image><img src=/p/ansible-configuration-backup-manager/_hu12225e3f406182c91634608ad7cb2c64_1239508_1af7a87b45fb3b73a9c1c716fe9eb0f9.png width=250 height=150 loading=lazy alt="Featured image of post Ansible Configuration Backup Manager" data-hash="md5-+TQ8PJ8mkUygm6V0xYsxfQ=="></div><div class=article-details><h2 class=article-title>Ansible Configuration Backup Manager</h2></div></a></article><article class=has-image><a href=/p/use-ansible-to-compare-cloud-ip-ranges-against-firewall-object/><div class=article-image><img src=/p/use-ansible-to-compare-cloud-ip-ranges-against-firewall-object/cloud-ip-checks-mini.b925f4ae2c26ca0fa275e985e926413d_hudd0ab147682fbdd31b8bb756e5cdd221_351688_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Use Ansible to compare Cloud IP Ranges against Firewall object" data-hash="md5-uSX0riwmyg+idemF6SZBPQ=="></div><div class=article-details><h2 class=article-title>Use Ansible to compare Cloud IP Ranges against Firewall object</h2></div></a></article><article class=has-image><a href=/p/bgpalerter-as-code-using-a-terraform-pipeline/><div class=article-image><img src=/p/bgpalerter-as-code-using-a-terraform-pipeline/front.fbc61346389f4ec97dce763988d6ce13_huaf53bc8ed3209b5b56820218227b86f5_395056_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post BGPAlerter As Code Using A Terraform Pipeline" data-hash="md5-+8YTRjifTsl9znY5iNbOEw=="></div><div class=article-details><h2 class=article-title>BGPAlerter As Code Using A Terraform Pipeline</h2></div></a></article><article class=has-image><a href=/p/automate-network-bandwidth-testing-with-python-and-iperf/><div class=article-image><img src=/p/automate-network-bandwidth-testing-with-python-and-iperf/_hu779ac677055344eb65e39a4877c2e8ce_279163_bfc38647e1fcc12bddda0bbda47da800.png width=250 height=150 loading=lazy alt="Featured image of post Automate Network Bandwidth Testing with Python and Iperf" data-hash="md5-PVHvbGD33YLDVbK+Ek0KXA=="></div><div class=article-details><h2 class=article-title>Automate Network Bandwidth Testing with Python and Iperf</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//kaonbytes-com.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2022 KaonBytes</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#purpose>Purpose</a><ol><li><a href=#the-steps>The Steps</a></li></ol></li><li><a href=#the-end-result>The End Result</a><ol><li><a href=#the-code>The Code</a></li><li><a href=#running-the-playbook>Running the playbook</a></li></ol></li><li><a href=#the-nuts-and-bolts-how-to>The Nuts and Bolts How-To</a><ol><li><a href=#declaring-intended-state>Declaring Intended State</a></li><li><a href=#source-of-truth---netbox>Source Of Truth - Netbox</a></li><li><a href=#config-context>Config Context</a></li><li><a href=#handling-credentials-and-secret-passwords>Handling Credentials And Secret Passwords</a><ol><li><a href=#creating-idempotent-secret-keys-from-passwords>Creating Idempotent Secret Keys from Passwords</a></li></ol></li><li><a href=#jinja2-template>Jinja2 Template</a></li><li><a href=#juniper-commit_check-feature>Juniper Commit_Check Feature</a></li><li><a href=#first-run-and-recurring-enforcement>First Run and Recurring Enforcement</a></li></ol></li><li><a href=#final-thoughts>Final Thoughts</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>