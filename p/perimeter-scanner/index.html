<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='Building an Automated Perimeter Scanning System with Open Source Tools - NMAP, IVRE and Netbox'><title>Perimeter Scanner</title>
<link rel=canonical href=https://kaonbytes.com/p/perimeter-scanner/><link rel=stylesheet href=/scss/style.min.450926226e724574a6b936335ea06111f8aeb253d932c86cb2cc807341cd2889.css><meta property='og:title' content='Perimeter Scanner'><meta property='og:description' content='Building an Automated Perimeter Scanning System with Open Source Tools - NMAP, IVRE and Netbox'><meta property='og:url' content='https://kaonbytes.com/p/perimeter-scanner/'><meta property='og:site_name' content='KaonBytes'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2023-05-05T00:00:00+00:00'><meta property='article:modified_time' content='2023-05-05T00:00:00+00:00'><meta property='og:image' content='https://kaonbytes.com/p/perimeter-scanner/images/perimeter-scanner-front.png'><meta name=twitter:site content="@kaon_123"><meta name=twitter:creator content="@kaon_123"><meta name=twitter:title content="Perimeter Scanner"><meta name=twitter:description content="Building an Automated Perimeter Scanning System with Open Source Tools - NMAP, IVRE and Netbox"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://kaonbytes.com/p/perimeter-scanner/images/perimeter-scanner-front.png'><link rel="shortcut icon" href=favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-LE0JVZ0N09"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LE0JVZ0N09")}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/profile-new_hu0424c52cde2ba37c8617ad2cd064c5ee_88533_300x0_resize_q75_box.jpg width=300 height=450 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>KaonBytes</a></h1><h2 class=site-description>Welcome to my technical blog on all things Networking, Security and Automation</h2></div></header><ol class=social-menu><li><a href=https://github.com/kaon1 target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/kaon1/ target=_blank title=LinkedIn><svg role="img" xmlns="http://www.w3.org/2000/svg" width="1e3mm" height="1e3mm" viewBox="0 0 1e3 1e3" style="max-width:1.6em;height:auto"><path id="path" style="opacity:1;vector-effect:none;fill:#000;fill-opacity:1" d="M336 332s0 457 0 457-125 0-125 0 0-457 0-457 125 0 125 0m10-126s0 0 0 0c0 41-33 74-73 74s-72-33-72-74c0-40 32-73 72-73s73 33 73 73M834 508s0 281 0 281-125 0-125 0 0-233 0-233c0-140-166-129-166 0V789s-124 0-124 0 0-457 0-457 124 0 124 0 0 74 0 74c58-108 291-116 291 102" transform=""/></svg></a></li><li><a href=https://twitter.com/kaonthana target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/learning-links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Learning Links</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://kaonbytes.com/ selected>English</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/perimeter-scanner/><img src=/p/perimeter-scanner/images/perimeter-scanner-front_huda0cd6a7d1bad9baa374d7c905f6581c_150841_800x0_resize_box_3.png srcset="/p/perimeter-scanner/images/perimeter-scanner-front_huda0cd6a7d1bad9baa374d7c905f6581c_150841_800x0_resize_box_3.png 800w, /p/perimeter-scanner/images/perimeter-scanner-front_huda0cd6a7d1bad9baa374d7c905f6581c_150841_1600x0_resize_box_3.png 1600w" width=800 height=311 loading=lazy alt="Featured image of post Perimeter Scanner"></a></div><div class=article-details><header class=article-category><a href=/categories/security/>Security
</a><a href=/categories/automation/>Automation
</a><a href=/categories/netbox/>Netbox
</a><a href=/categories/netdevops/>Netdevops</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/perimeter-scanner/>Perimeter Scanner</a></h2><h3 class=article-subtitle>Building an Automated Perimeter Scanning System with Open Source Tools - NMAP, IVRE and Netbox</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>May 05, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>8 minute read</time></div></footer></div></header><section class=article-content><h2 id=about>About</h2><p>I put together a system of components to perform <strong>automated perimeter scanning</strong> using readily available open source tools. Here is a guide on how you can do the same thing.</p><p>The system can accomplish the following:</p><ul><li>Actively <strong>port scan</strong> your IP address space (please do not scan IP space that you do not control!)</li><li>Store results in a <strong>structured database</strong> which can provide a snapshot of the state of the perimeter.</li><li>Perform programmatic checks comparing <strong>current state vs desired state</strong> and report on discrepancies.</li></ul><h3 id=why-port-scan>Why Port Scan?</h3><p>As network admins, we manage large pools of address space which host various services and expose ports for internal and external connections. In general, these available services are documented, firewalled and compliant to standards.</p><p>However, human error, misconfigurations, or vendor patches may cause <strong>undesired services</strong> to be exposed on the network. Port scanning (or port knocking) is one way to determine if these unintended services exist.</p><p>Port scanning is just one tool we can use to mitigate vulnerabilities. If we follow the <a class=link href=https://en.wikipedia.org/wiki/Swiss_cheese_model target=_blank rel=noopener>swiss cheese model</a> of layered security, adding this check is beneficial in overall network security posture.</p><h3 id=the-tools>The Tools</h3><ul><li><p>Scanning Engine &mdash; Nmap</p><ul><li><a class=link href=https://nmap.org/ target=_blank rel=noopener>Nmap</a> is a free and open source utility for network discovery and security auditing.</li></ul></li><li><p>Framework &mdash; IVRE</p><ul><li><a class=link href=https://github.com/ivre/ivre target=_blank rel=noopener>IVRE</a> provides the framework to store, view and manipulate the scan results from nmap</li></ul></li><li><p>Source of Truth &mdash; Netbox</p><ul><li><a class=link href=https://github.com/netbox-community/netbox target=_blank rel=noopener>Netbox</a> is used to ingest targets to be scanned and as a reference for desired state</li></ul></li></ul><h2 id=the-end-result>The End Result</h2><h3 id=generated-report>Generated Report</h3><p><img src=/p/perimeter-scanner/images/email-summary.png width=1176 height=1904 srcset="/p/perimeter-scanner/images/email-summary_hu8a697b6ef61f3b8fec74acc8efa2407e_277245_480x0_resize_box_3.png 480w, /p/perimeter-scanner/images/email-summary_hu8a697b6ef61f3b8fec74acc8efa2407e_277245_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=61 data-flex-basis=148px></p><h3 id=ivre-view-database>IVRE View Database</h3><p><img src=/p/perimeter-scanner/images/web-view.png width=2233 height=2085 srcset="/p/perimeter-scanner/images/web-view_hu8439babf6c2b82dfa16490566a3b8b37_415074_480x0_resize_box_3.png 480w, /p/perimeter-scanner/images/web-view_hu8439babf6c2b82dfa16490566a3b8b37_415074_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=107 data-flex-basis=257px></p><h3 id=project-code>Project Code</h3><p>Github Repo of the code can be <a class=link href=https://github.com/kaon1/perimeter-scanner target=_blank rel=noopener>found here</a></p><h2 id=system-implementation>System Implementation</h2><h3 id=execution-timeline>Execution Timeline</h3><p><img src=/p/perimeter-scanner/images/timeline.png width=2606 height=3407 srcset="/p/perimeter-scanner/images/timeline_hu1ff6ad209bd3abb1353f7cd7aebd7487_535387_480x0_resize_box_3.png 480w, /p/perimeter-scanner/images/timeline_hu1ff6ad209bd3abb1353f7cd7aebd7487_535387_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=76 data-flex-basis=183px></p><ul><li>Scheduled <a class=link href=https://github.com/kaon1/perimeter-scanner/blob/main/pscanner/crontab.txt target=_blank rel=noopener>cronjob</a> starts <a class=link href=https://github.com/kaon1/perimeter-scanner/blob/main/pscanner/pscan_spawn_jobs.py target=_blank rel=noopener>pscan_spawn_jobs.py</a> and does the following:<ul><li>Makes an API call to netbox to grab all prefixes and IP addresses tagged for scanning</li><li>Spawns two nmap jobs per result (one TCP scan and one UDP scan)</li></ul></li><li>NMAP Scans run in the background on Network Targets and output the data as .XML files saved locally</li><li><a class=link href=https://github.com/kaon1/perimeter-scanner/blob/main/pscanner/pscan_db_job.sh target=_blank rel=noopener>pscan_db_job.sh</a> is kicked off which does the following:<ul><li>Initializes the IVRE Web View</li><li>Imports the newest scans into the IVRE Database</li><li>Creates two new web views in IVRE - Last Week&rsquo;s Scans and This Week&rsquo;s Scans</li></ul></li><li><a class=link href=https://github.com/kaon1/perimeter-scanner/blob/main/pscanner/export_recent_changes.py target=_blank rel=noopener>export_recent_changes.py</a> and <a class=link href=https://github.com/kaon1/perimeter-scanner/blob/main/pscanner/print_recent_scan.py target=_blank rel=noopener>print_recent_scan.py</a> kickoff which compare the scan data vs the desired data in netbox</li><li><a class=link href=https://github.com/kaon1/perimeter-scanner/blob/main/pscanner/create_email_report.py target=_blank rel=noopener>create_email_report.py</a> ingests the data and generates an email report to be sent</li></ul><h3 id=nmap-options-explained>Nmap Options Explained</h3><p><img src=/p/perimeter-scanner/images/nmap-explained.png width=3450 height=1586 srcset="/p/perimeter-scanner/images/nmap-explained_hu2889ddb96dca71f79ab272c4c0c70505_81029_480x0_resize_box_3.png 480w, /p/perimeter-scanner/images/nmap-explained_hu2889ddb96dca71f79ab272c4c0c70505_81029_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=217 data-flex-basis=522px></p><h3 id=pscan_spawn_jobspy>pscan_spawn_jobs.py</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>ipaddress</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>netutils.ip</span> <span class=kn>import</span> <span class=n>netmask_to_cidr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>### start by killing all nmap processes (if they are running)</span>
</span></span><span class=line><span class=cl><span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>([</span><span class=s1>&#39;killall&#39;</span><span class=p>,</span> <span class=s1>&#39;-9&#39;</span><span class=p>,</span> <span class=s1>&#39;nmap&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## this is the tag used in netbox to classify prefixes and ips to scan</span>
</span></span><span class=line><span class=cl><span class=n>nmap_tag</span> <span class=o>=</span> <span class=s2>&#34;nmap_scanning&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>netbox_url</span> <span class=o>=</span> <span class=s1>&#39;https://netbox&#39;</span>
</span></span><span class=line><span class=cl><span class=n>netbox_token</span> <span class=o>=</span> <span class=s1>&#39;token&#39;</span>
</span></span><span class=line><span class=cl><span class=n>netbox_headers</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;Authorization&#39;</span><span class=p>:</span> <span class=s2>&#34;Token </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>netbox_token</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># writing date files</span>
</span></span><span class=line><span class=cl><span class=n>date_parser</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>date_stamp</span> <span class=o>=</span> <span class=n>date_parser</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&#34;%Y-%m-</span><span class=si>%d</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prev_date_parser</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=-</span><span class=mi>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>prev_date_stamp</span> <span class=o>=</span> <span class=n>prev_date_parser</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&#34;%Y-%m-</span><span class=si>%d</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>current_scan_fh</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;/opt/ivre/ivre-opt/current_scan_date.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>previous_scan_fh</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;/opt/ivre/ivre-opt/previous_scan_date.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>current_scan_fh</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>date_stamp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>current_scan_fh</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>previous_scan_fh</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>prev_date_stamp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>previous_scan_fh</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># end writing date files</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># nmap args to use for TCP Scans</span>
</span></span><span class=line><span class=cl><span class=n>nmap_base_args</span> <span class=o>=</span> <span class=s2>&#34;nohup nmap --log-errors --open -T3 -Pn -sS --top-ports 2000 -oX /opt/ivre/ivre-share/&#34;</span><span class=o>+</span><span class=n>date_stamp</span><span class=o>+</span><span class=s2>&#34;_tcp_&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># nmap args to use for UDP Scans</span>
</span></span><span class=line><span class=cl><span class=n>nmap_base_args_udp</span> <span class=o>=</span> <span class=s2>&#34;nohup nmap --log-errors --open -T3 -Pn -sU --top-ports 250 -oX /opt/ivre/ivre-share/&#34;</span><span class=o>+</span><span class=n>date_stamp</span><span class=o>+</span><span class=s2>&#34;_udp_&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># netbox api calls to grab all ip addresses and prefixes tagged with nmap_scanning tag</span>
</span></span><span class=line><span class=cl><span class=n>netbox_api_ip_addr</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>netbox_url</span><span class=o>+</span><span class=s2>&#34;/api/ipam/ip-addresses/?limit=0&amp;tag=&#34;</span><span class=o>+</span><span class=n>nmap_tag</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>netbox_headers</span><span class=p>,</span> <span class=n>verify</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>netbox_api_ip_prefix</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>netbox_url</span><span class=o>+</span><span class=s2>&#34;/api/ipam/prefixes/?limit=0&amp;tag=&#34;</span><span class=o>+</span><span class=n>nmap_tag</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>netbox_headers</span><span class=p>,</span> <span class=n>verify</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># function to take in address like 172.3.3.0/25 and return 172_3_3_0 and netmask 25</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>explode_address_elements</span><span class=p>(</span><span class=n>address_to_scan</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>exploded_elements_dict</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=n>exploded_elements_dict</span><span class=p>[</span><span class=s1>&#39;address_to_scan_exploded&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>ipaddress</span><span class=o>.</span><span class=n>IPv4Interface</span><span class=p>(</span><span class=n>address_to_scan</span><span class=p>)</span><span class=o>.</span><span class=n>ip</span><span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;.&#39;</span><span class=p>,</span> <span class=s1>&#39;_&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>exploded_elements_dict</span><span class=p>[</span><span class=s1>&#39;address_to_scan_mask&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>netmask_to_cidr</span><span class=p>((</span><span class=n>ipaddress</span><span class=o>.</span><span class=n>IPv4Interface</span><span class=p>(</span><span class=n>address_to_scan</span><span class=p>)</span><span class=o>.</span><span class=n>netmask</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>exploded_elements_dict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># function to spawn one nmap job per ingested prefix or ip address</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>spawn_nmap_jobs</span><span class=p>(</span><span class=n>address_to_scan</span><span class=p>,</span> <span class=n>address_to_scan_exploded</span><span class=p>,</span> <span class=n>address_to_scan_mask</span><span class=p>,</span> <span class=n>is_prefix</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>is_prefix</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>## spawn tcp scans</span>
</span></span><span class=line><span class=cl>        <span class=n>nmap_raw_cmd</span> <span class=o>=</span> <span class=n>nmap_base_args</span><span class=o>+</span><span class=n>address_to_scan_exploded</span><span class=o>+</span><span class=s2>&#34;_&#34;</span> <span class=o>+</span> <span class=n>address_to_scan_mask</span><span class=o>+</span><span class=s2>&#34;.xml &#34;</span><span class=o>+</span><span class=n>address_to_scan</span>
</span></span><span class=line><span class=cl>        <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>nmap_raw_cmd</span><span class=o>.</span><span class=n>split</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>##spawn udp scans</span>
</span></span><span class=line><span class=cl>        <span class=n>nmap_raw_cmd</span> <span class=o>=</span> <span class=n>nmap_base_args_udp</span><span class=o>+</span><span class=n>address_to_scan_exploded</span><span class=o>+</span><span class=s2>&#34;_&#34;</span> <span class=o>+</span> <span class=n>address_to_scan_mask</span><span class=o>+</span><span class=s2>&#34;.xml &#34;</span><span class=o>+</span><span class=n>address_to_scan</span>
</span></span><span class=line><span class=cl>        <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>nmap_raw_cmd</span><span class=o>.</span><span class=n>split</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1>## spawn tcp scans</span>
</span></span><span class=line><span class=cl>        <span class=n>nmap_raw_cmd</span> <span class=o>=</span> <span class=n>nmap_base_args</span><span class=o>+</span><span class=n>address_to_scan_exploded</span><span class=o>+</span><span class=s2>&#34;_&#34;</span> <span class=o>+</span> <span class=n>address_to_scan_mask</span><span class=o>+</span><span class=s2>&#34;.xml &#34;</span><span class=o>+</span><span class=n>address_to_scan</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>nmap_raw_cmd</span><span class=o>.</span><span class=n>split</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>## spawn udp scans</span>
</span></span><span class=line><span class=cl>        <span class=n>nmap_raw_cmd</span> <span class=o>=</span> <span class=n>nmap_base_args_udp</span><span class=o>+</span><span class=n>address_to_scan_exploded</span><span class=o>+</span><span class=s2>&#34;_&#34;</span> <span class=o>+</span> <span class=n>address_to_scan_mask</span><span class=o>+</span><span class=s2>&#34;.xml &#34;</span><span class=o>+</span><span class=n>address_to_scan</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>nmap_raw_cmd</span><span class=o>.</span><span class=n>split</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># iterate through netbox ip address query results and start the nmap job</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>ip_addr</span> <span class=ow>in</span> <span class=n>netbox_api_ip_addr</span><span class=p>[</span><span class=s1>&#39;results&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=n>ip_elements</span> <span class=o>=</span> <span class=n>explode_address_elements</span><span class=p>(</span><span class=n>ip_addr</span><span class=p>[</span><span class=s1>&#39;address&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>spawn_nmap_jobs</span><span class=p>(</span><span class=n>ip_addr</span><span class=p>[</span><span class=s1>&#39;address&#39;</span><span class=p>],</span> <span class=n>ip_elements</span><span class=p>[</span><span class=s1>&#39;address_to_scan_exploded&#39;</span><span class=p>],</span> <span class=n>ip_elements</span><span class=p>[</span><span class=s1>&#39;address_to_scan_mask&#39;</span><span class=p>],</span> <span class=n>is_prefix</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># iterate through netbox prefix query results and start the nmap job</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>prefix</span> <span class=ow>in</span> <span class=n>netbox_api_ip_prefix</span><span class=p>[</span><span class=s1>&#39;results&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=n>ip_elements</span> <span class=o>=</span> <span class=n>explode_address_elements</span><span class=p>(</span><span class=n>prefix</span><span class=p>[</span><span class=s1>&#39;prefix&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>spawn_nmap_jobs</span><span class=p>(</span><span class=n>prefix</span><span class=p>[</span><span class=s1>&#39;prefix&#39;</span><span class=p>],</span> <span class=n>ip_elements</span><span class=p>[</span><span class=s1>&#39;address_to_scan_exploded&#39;</span><span class=p>],</span> <span class=n>ip_elements</span><span class=p>[</span><span class=s1>&#39;address_to_scan_mask&#39;</span><span class=p>],</span> <span class=n>is_prefix</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># all jobs should be started now and script exits. With current params the jobs will complete in 24 hours</span>
</span></span><span class=line><span class=cl><span class=c1># example output of psaux www</span>
</span></span><span class=line><span class=cl><span class=c1>###</span>
</span></span><span class=line><span class=cl><span class=c1>## nmap --log-errors --open -T4 -Pn -sS --top-ports 2000 -oX /opt/ivre/ivre-share/2023-02-08_tcp_172_1_1_0_23.xml 172.1.1.0/23</span>
</span></span><span class=line><span class=cl><span class=c1>## nmap --log-errors --open -T4 -Pn -sU --top-ports 250 -oX /opt/ivre/ivre-share/2023-02-08_udp_172_2_2_0_23.xml 172.2.2.0/23</span>
</span></span></code></pre></div><h4 id=ps-auxww>ps auxww</h4><p>Example list of spawned nmap processes during the scanning window.</p><p><img src=/p/perimeter-scanner/images/pscan-nmaps.PNG width=1280 height=585 srcset="/p/perimeter-scanner/images/pscan-nmaps_hud36cc2530b5437b3eea41df922f6dfc1_771669_480x0_resize_box_3.PNG 480w, /p/perimeter-scanner/images/pscan-nmaps_hud36cc2530b5437b3eea41df922f6dfc1_771669_1024x0_resize_box_3.PNG 1024w" loading=lazy class=gallery-image data-flex-grow=218 data-flex-basis=525px></p><h4 id=xml-results-file>xml results file</h4><p><img src=/p/perimeter-scanner/images/xml-results.png width=1183 height=1766 srcset="/p/perimeter-scanner/images/xml-results_hu855660dcb98b724cea0125925c5f4747_245979_480x0_resize_box_3.png 480w, /p/perimeter-scanner/images/xml-results_hu855660dcb98b724cea0125925c5f4747_245979_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=66 data-flex-basis=160px></p><h3 id=processing-the-results>Processing the Results</h3><p><img src=/p/perimeter-scanner/images/process-results.png width=3255 height=2576 srcset="/p/perimeter-scanner/images/process-results_hu5f9c98f46dde95848f703365721245be_138579_480x0_resize_box_3.png 480w, /p/perimeter-scanner/images/process-results_hu5f9c98f46dde95848f703365721245be_138579_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=126 data-flex-basis=303px></p><h4 id=import-scan-results-into-ivre-db>Import Scan Results into IVRE DB</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1># Bash file to run on ivre-client container with command</span>
</span></span><span class=line><span class=cl><span class=c1># docker exec -i ivreclient /bin/bash /ivre-opt/pscan_db_job.sh</span>
</span></span><span class=line><span class=cl><span class=c1># 1. Purge the view database (web gui view) to start fresh</span>
</span></span><span class=line><span class=cl><span class=c1># 2. Import the latest scan into scan database</span>
</span></span><span class=line><span class=cl><span class=c1># 3. Create two new views -- 1. View of previous scan 2. View of Newest Current Scan</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/bin/sh -c <span class=s2>&#34;echo yes | ivre view --purgedb&#34;</span>
</span></span><span class=line><span class=cl>/bin/sh -c <span class=s2>&#34;ivre scan2db --open-ports -s SCAN_SERVER -c pscan_</span><span class=k>$(</span>cat <span class=s2>&#34;/ivre-opt/current_scan_date.txt&#34;</span><span class=k>)</span><span class=s2> /ivre-share/</span><span class=k>$(</span>cat <span class=s2>&#34;/ivre-opt/current_scan_date.txt&#34;</span><span class=k>)</span><span class=s2>*.xml&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/bin/sh -c <span class=s2>&#34;ivre db2view --no-merge nmap --category pscan_</span><span class=k>$(</span>cat <span class=s2>&#34;/ivre-opt/previous_scan_date.txt&#34;</span><span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>/bin/sh -c <span class=s2>&#34;ivre db2view --no-merge nmap --category pscan_</span><span class=k>$(</span>cat <span class=s2>&#34;/ivre-opt/current_scan_date.txt&#34;</span><span class=k>)</span><span class=s2>&#34;</span>
</span></span></code></pre></div><h4 id=show-most-recent-scan-results-from-db>Show most recent scan results from DB</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>### Script run on ivre client container to print out latest scan results from mongo DB</span>
</span></span><span class=line><span class=cl><span class=c1>### Calls the mongo query: list(db.view.get_ips_ports(flt=db.view.searchcategory(&#34;pscan_&#34;+current_date))[0])</span>
</span></span><span class=line><span class=cl><span class=c1>### Converts results to a json dict exported to recent_scan_results.json so future script can read it for email generation</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ivre.db</span> <span class=kn>import</span> <span class=n>db</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>file1</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;/ivre-opt/current_scan_date.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>current_date</span> <span class=o>=</span> <span class=n>file1</span><span class=o>.</span><span class=n>readline</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>file1</span><span class=o>.</span><span class=n>close</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>result_list</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Data to be written</span>
</span></span><span class=line><span class=cl><span class=n>scan_export</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>view</span><span class=o>.</span><span class=n>get_ips_ports</span><span class=p>(</span><span class=n>flt</span><span class=o>=</span><span class=n>db</span><span class=o>.</span><span class=n>view</span><span class=o>.</span><span class=n>searchcategory</span><span class=p>(</span><span class=s2>&#34;pscan_&#34;</span><span class=o>+</span><span class=n>current_date</span><span class=p>))[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>result</span> <span class=ow>in</span> <span class=n>scan_export</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>result_list</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;ip_address&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;addr&#39;</span><span class=p>],</span> <span class=s2>&#34;ports&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;ports&#39;</span><span class=p>]})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>json_obj</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>result_list</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;/ivre-opt/recent_scan_result.json&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>outfile</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>outfile</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>json_obj</span><span class=p>)</span>
</span></span></code></pre></div><h4 id=show-whats-changed-from-last-scan>Show what&rsquo;s changed from last scan</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>### Script run on ivre client container to print out latest diff of changes from previous scan to current scan</span>
</span></span><span class=line><span class=cl><span class=c1>### Calls the mongo query: list(db.view.diff_categories(category1=&#34;1&#34;,category2=&#34;2&#34;,include_both_open=False))</span>
</span></span><span class=line><span class=cl><span class=c1>### Converts results to a json dict exported to whats_changed.json so future script can read it for email generation</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ivre.db</span> <span class=kn>import</span> <span class=n>db</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>file1</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;/ivre-opt/current_scan_date.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>current_date</span> <span class=o>=</span> <span class=n>file1</span><span class=o>.</span><span class=n>readline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>file1</span><span class=o>.</span><span class=n>close</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>file2</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;/ivre-opt/previous_scan_date.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>previous_date</span> <span class=o>=</span> <span class=n>file2</span><span class=o>.</span><span class=n>readline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>file2</span><span class=o>.</span><span class=n>close</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>result_list</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>value_map</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;-1&#34;</span><span class=p>:</span> <span class=s2>&#34;No Longer Detected&#34;</span><span class=p>,</span> <span class=s2>&#34;0&#34;</span><span class=p>:</span> <span class=s2>&#34;Still Open: Open in previous scan &#34;</span><span class=o>+</span><span class=n>previous_date</span><span class=o>+</span><span class=s2>&#34; and open in current scan &#34;</span><span class=o>+</span><span class=n>current_date</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>:</span> <span class=s2>&#34;Newly Detected&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Data to be written</span>
</span></span><span class=line><span class=cl><span class=n>scan_export</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>view</span><span class=o>.</span><span class=n>diff_categories</span><span class=p>(</span><span class=n>category1</span><span class=o>=</span><span class=s2>&#34;pscan_&#34;</span><span class=o>+</span><span class=n>previous_date</span><span class=p>,</span><span class=n>category2</span><span class=o>=</span><span class=s2>&#34;pscan_&#34;</span><span class=o>+</span><span class=n>current_date</span><span class=p>,</span><span class=n>include_both_open</span><span class=o>=</span><span class=kc>False</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>result</span> <span class=ow>in</span> <span class=n>scan_export</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>result_list</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;ip_address&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;addr&#39;</span><span class=p>],</span> <span class=s2>&#34;protocol&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;proto&#39;</span><span class=p>],</span> <span class=s2>&#34;port&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;port&#39;</span><span class=p>],</span> <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=n>value_map</span><span class=p>[</span><span class=nb>str</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;value&#39;</span><span class=p>])]})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sorted_result_list</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>result_list</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>d</span><span class=p>:</span> <span class=n>d</span><span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>])</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>json_obj</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>sorted_result_list</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;/ivre-opt/whats_changed.json&#34;</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>outfile</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>outfile</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>json_obj</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=generating-report-data>Generating Report Data</h3><p><img src=/p/perimeter-scanner/images/generate-report.png width=2700 height=2424 srcset="/p/perimeter-scanner/images/generate-report_huebd5766dded274484af78c0d75f30a2d_543353_480x0_resize_box_3.png 480w, /p/perimeter-scanner/images/generate-report_huebd5766dded274484af78c0d75f30a2d_543353_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=111 data-flex-basis=267px></p><h4 id=comparing-results-to-desired-state>Comparing Results to Desired State</h4><p>We can create a custom field in <strong>Netbox</strong> to declare the known open ports per IP Address.
Example:
<img src=/p/perimeter-scanner/images/nebtox_custom_fields.png width=478 height=457 srcset="/p/perimeter-scanner/images/nebtox_custom_fields_hu87fa3f5d9cb1d2ce17397c5c7e5956ba_23331_480x0_resize_box_3.png 480w, /p/perimeter-scanner/images/nebtox_custom_fields_hu87fa3f5d9cb1d2ce17397c5c7e5956ba_23331_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=104 data-flex-basis=251px></p><h4 id=creating-the-report>Creating the report</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>jinja2</span> <span class=kn>import</span> <span class=n>Template</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>smtplib</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>### global vars</span>
</span></span><span class=line><span class=cl><span class=n>netbox_url</span> <span class=o>=</span> <span class=s1>&#39;https://netbox&#39;</span>
</span></span><span class=line><span class=cl><span class=n>netbox_token</span> <span class=o>=</span> <span class=s1>&#39;token&#39;</span>
</span></span><span class=line><span class=cl><span class=n>netbox_headers</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;Authorization&#39;</span><span class=p>:</span> <span class=s2>&#34;Token </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>netbox_token</span><span class=p>)}</span>
</span></span><span class=line><span class=cl><span class=n>date_parser</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span> 
</span></span><span class=line><span class=cl><span class=n>date_stamp</span> <span class=o>=</span> <span class=n>date_parser</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&#34;%Y-%m-</span><span class=si>%d</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>recent_scan_filename</span> <span class=o>=</span> <span class=s2>&#34;/opt/ivre/ivre-opt/recent_scan_result.json&#34;</span>
</span></span><span class=line><span class=cl><span class=n>whats_changed_filename</span> <span class=o>=</span> <span class=s2>&#34;/opt/ivre/ivre-opt/whats_changed.json&#34;</span>
</span></span><span class=line><span class=cl><span class=n>output_list_no_reason</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>output_list_all</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>### functions</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>### Search if IP + Port Combo exists in netbox custom field called &#39;known open ports</span>
</span></span><span class=line><span class=cl><span class=c1>### example 172.1.1.5--&gt;443 see if exists in data structure:</span>
</span></span><span class=line><span class=cl><span class=c1># {&#39;known_open_ports&#39;: [</span>
</span></span><span class=line><span class=cl><span class=c1>#        {&#39;port&#39;: 443, &#39;reason&#39;: &#39;web server&#39;, &#39;protocol&#39;: &#39;tcp&#39;</span>
</span></span><span class=line><span class=cl><span class=c1>#        }</span>
</span></span><span class=line><span class=cl><span class=c1>#    ]</span>
</span></span><span class=line><span class=cl><span class=c1># }</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_netbox_known_ports_justification</span><span class=p>(</span><span class=n>ip_address</span><span class=p>,</span><span class=n>port</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ipam_api_call</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>netbox_url</span><span class=o>+</span><span class=s2>&#34;/api/ipam/ip-addresses/?address=&#34;</span><span class=o>+</span><span class=n>ip_address</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>netbox_headers</span><span class=p>,</span> <span class=n>verify</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>ipam_api_call</span><span class=p>[</span><span class=s1>&#39;results&#39;</span><span class=p>])</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>known_ports_list</span> <span class=o>=</span> <span class=n>ipam_api_call</span><span class=p>[</span><span class=s1>&#39;results&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;custom_fields&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>known_ports_list</span><span class=p>[</span><span class=s1>&#39;known_open_ports&#39;</span><span class=p>]</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>known_port</span> <span class=ow>in</span> <span class=n>known_ports_list</span><span class=p>[</span><span class=s1>&#39;known_open_ports&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>known_port</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;port&#39;</span><span class=p>)</span> <span class=o>==</span> <span class=n>port</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>known_port</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;reason&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;No Justification&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;No Justification&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;No Justification&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_recent_scan</span><span class=p>(</span><span class=n>filename</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>### Gather Data</span>
</span></span><span class=line><span class=cl><span class=n>recent_scan_results_dict</span> <span class=o>=</span> <span class=n>get_recent_scan</span><span class=p>(</span><span class=n>recent_scan_filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>whats_changed_dict</span> <span class=o>=</span> <span class=n>get_recent_scan</span><span class=p>(</span><span class=n>whats_changed_filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>### Iterate through every entry of most recent scan and compare each entry to netbox &#34;known open port&#34; field</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=n>recent_scan_results_dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>     <span class=k>for</span> <span class=n>discovered_port</span> <span class=ow>in</span> <span class=n>entry</span><span class=p>[</span><span class=s1>&#39;ports&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=c1>## ignore udp open/filtered state as its not truly open</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>discovered_port</span><span class=p>[</span><span class=s1>&#39;state_state&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;open&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>reason</span> <span class=o>=</span> <span class=n>get_netbox_known_ports_justification</span><span class=p>(</span><span class=n>entry</span><span class=p>[</span><span class=s1>&#39;ip_address&#39;</span><span class=p>],</span><span class=n>discovered_port</span><span class=p>[</span><span class=s1>&#39;port&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>reason</span> <span class=o>==</span> <span class=s2>&#34;No Justification&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>output_list_no_reason</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;IP Address&#34;</span><span class=p>:</span> <span class=n>entry</span><span class=p>[</span><span class=s1>&#39;ip_address&#39;</span><span class=p>],</span><span class=s2>&#34;Open Port&#34;</span><span class=p>:</span> <span class=n>discovered_port</span><span class=p>[</span><span class=s1>&#39;port&#39;</span><span class=p>],</span> <span class=s2>&#34;Reason&#34;</span><span class=p>:</span> <span class=n>reason</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>output_list_all</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;IP Address&#34;</span><span class=p>:</span> <span class=n>entry</span><span class=p>[</span><span class=s1>&#39;ip_address&#39;</span><span class=p>],</span><span class=s2>&#34;Open Port&#34;</span><span class=p>:</span> <span class=n>discovered_port</span><span class=p>[</span><span class=s1>&#39;port&#39;</span><span class=p>],</span> <span class=s2>&#34;Reason&#34;</span><span class=p>:</span> <span class=n>reason</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>### Build Email Template</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;/opt/ivre/ivre-opt/email_template.j2&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>rendered</span> <span class=o>=</span> <span class=n>Template</span><span class=p>(</span><span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>())</span><span class=o>.</span><span class=n>render</span><span class=p>(</span><span class=n>date_stamp</span><span class=o>=</span><span class=n>date_stamp</span><span class=p>,</span><span class=n>output_list_no_reason</span><span class=o>=</span><span class=n>output_list_no_reason</span><span class=p>,</span><span class=n>output_list_all</span><span class=o>=</span><span class=n>output_list_all</span><span class=p>,</span><span class=n>whats_changed_dict</span><span class=o>=</span><span class=n>whats_changed_dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>message</span> <span class=o>=</span> <span class=s1>&#39;Subject: </span><span class=si>{}</span><span class=se>\n\n</span><span class=si>{}</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s2>&#34;Network Perimeter Port Scanner Summary&#34;</span><span class=p>,</span> <span class=n>rendered</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>s</span> <span class=o>=</span> <span class=n>smtplib</span><span class=o>.</span><span class=n>SMTP</span><span class=p>(</span><span class=s1>&#39;smtp-server&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=o>.</span><span class=n>sendmail</span><span class=p>(</span><span class=s1>&#39;pscanner@domain&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;notify@domain&#39;</span><span class=p>],</span> <span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=o>.</span><span class=n>sendmail</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>s</span><span class=o>.</span><span class=n>quit</span><span class=p>()</span>
</span></span></code></pre></div><h4 id=email-template---jinja2>Email Template - Jinja2</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>Network</span> <span class=n>Perimeter</span> <span class=n>Port</span> <span class=n>Scanner</span> <span class=n>Summary</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Web</span> <span class=n>View</span><span class=p>:</span> <span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>pscanner</span><span class=o>/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>IP</span> <span class=n>Addresses</span> <span class=ow>and</span> <span class=n>Prefixes</span> <span class=n>Tagged</span> <span class=k>for</span> <span class=n>Scanning</span><span class=p>:</span> <span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>netbox</span><span class=o>/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>---------------------------------------------------------------------------------------------------</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>List</span> <span class=n>of</span> <span class=n>Open</span> <span class=n>Services</span> <span class=n>that</span> <span class=n>are</span> <span class=ow>not</span> <span class=n>justified</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=o>%</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>output_list_no_reason</span> <span class=o>%</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>IP</span> <span class=o>--&gt;</span> <span class=p>{{</span> <span class=n>item</span><span class=p>[</span><span class=s1>&#39;IP Address&#39;</span><span class=p>]</span> <span class=p>}}</span> <span class=o>|</span> <span class=n>Open_Port</span> <span class=o>--&gt;</span> <span class=p>{{</span> <span class=n>item</span><span class=p>[</span><span class=s1>&#39;Open Port&#39;</span><span class=p>]</span> <span class=p>}}</span> <span class=o>|</span> <span class=n>Reason</span> <span class=o>--&gt;</span> <span class=p>{{</span> <span class=n>item</span><span class=p>[</span><span class=s1>&#39;Reason&#39;</span><span class=p>]</span> <span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=o>%</span> <span class=n>endfor</span> <span class=o>%</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>List</span> <span class=n>of</span> <span class=n>Changes</span> <span class=n>From</span> <span class=n>Previous</span> <span class=n>Scan</span> <span class=n>to</span> <span class=n>Current</span> <span class=n>Scan</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=o>%</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>whats_changed_dict</span> <span class=o>%</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>IP</span> <span class=o>--&gt;</span> <span class=p>{{</span> <span class=n>item</span><span class=p>[</span><span class=s1>&#39;ip_address&#39;</span><span class=p>]</span> <span class=p>}}</span> <span class=o>|</span> <span class=n>Proto</span> <span class=o>--&gt;</span> <span class=p>{{</span> <span class=n>item</span><span class=p>[</span><span class=s1>&#39;protocol&#39;</span><span class=p>]</span> <span class=p>}}</span> <span class=o>|</span> <span class=n>Port</span> <span class=o>--&gt;</span> <span class=p>{{</span> <span class=n>item</span><span class=p>[</span><span class=s1>&#39;port&#39;</span><span class=p>]</span> <span class=p>}}</span> <span class=o>|</span> <span class=n>Change</span> <span class=o>--&gt;</span> <span class=p>{{</span> <span class=n>item</span><span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>]</span> <span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=o>%</span> <span class=n>endfor</span> <span class=o>%</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>List</span> <span class=n>of</span> <span class=n>Current</span> <span class=n>Open</span> <span class=n>Services</span> <span class=k>with</span> <span class=n>Justifications</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=o>%</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>output_list_all</span> <span class=o>%</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>IP</span> <span class=o>--&gt;</span> <span class=p>{{</span> <span class=n>item</span><span class=p>[</span><span class=s1>&#39;IP Address&#39;</span><span class=p>]</span> <span class=p>}}</span> <span class=o>|</span> <span class=n>Open_Port</span> <span class=o>--&gt;</span> <span class=p>{{</span> <span class=n>item</span><span class=p>[</span><span class=s1>&#39;Open Port&#39;</span><span class=p>]</span> <span class=p>}}</span> <span class=o>|</span> <span class=n>Reason</span> <span class=o>--&gt;</span> <span class=p>{{</span> <span class=n>item</span><span class=p>[</span><span class=s1>&#39;Reason&#39;</span><span class=p>]</span> <span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=o>%</span> <span class=n>endfor</span> <span class=o>%</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>---------------------------------------------------------------------------------------------------</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Date</span><span class=p>:</span> <span class=s2>&#34;{{ date_stamp }}&#34;</span>
</span></span></code></pre></div><h2 id=end>End</h2><p>I never know how to end these posts, so for the small percentage of readers who stuck it out til the end, heres a gif of a robot dancing. Thanks for reading!</p><p><img src=/p/perimeter-scanner/images/robot-gif.gif width=305 height=480 srcset="/p/perimeter-scanner/images/robot-gif_hu510aedc94c255f888a42f053cac829b5_25101_480x0_resize_box_1.gif 480w, /p/perimeter-scanner/images/robot-gif_hu510aedc94c255f888a42f053cac829b5_25101_1024x0_resize_box_1.gif 1024w" loading=lazy class=gallery-image data-flex-grow=63 data-flex-basis=152px></p></section><footer class=article-footer></footer></article><aside class=related-contents--wrapper><h2 class=section-title>Related contents</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/p/slack-ipam-helper/><div class=article-image><img src=/p/slack-ipam-helper/images/ipam-helper-front.059c631bacc91c912d4cb0a7cbb4037f_hu0b4c396984346b48c89ef05d3f4ab66d_78125_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Slack IPAM Helper" data-hash="md5-BZxjG6zJHJEtTLCny7QDfw=="></div><div class=article-details><h2 class=article-title>Slack IPAM Helper</h2></div></a></article><article class=has-image><a href=/p/golden-configuration-deployment-with-ansible-and-netbox/><div class=article-image><img src=/p/golden-configuration-deployment-with-ansible-and-netbox/golden-config-front.0a95a4dbc7df190c14802b057fde04f9_hu3972f5f5b3bf12cabffe22f75756d981_1247419_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Golden Configuration Deployment with Ansible and Netbox" data-hash="md5-CpWk28ffGQwUgCsFf94E+Q=="></div><div class=article-details><h2 class=article-title>Golden Configuration Deployment with Ansible and Netbox</h2></div></a></article><article class=has-image><a href=/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/><div class=article-image><img src=/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/_hu91008c89e08c35be24c68bc187db22be_244905_6b7b6c28489eabc0762e130a45e366ac.png width=250 height=150 loading=lazy alt="Featured image of post Netbox Dynamic Inventory for Ansible as a feedback loop" data-hash="md5-isvFNqFle3F1LJV2T6/Njg=="></div><div class=article-details><h2 class=article-title>Netbox Dynamic Inventory for Ansible as a feedback loop</h2></div></a></article><article class=has-image><a href=/p/building-a-datacenter-as-code-with-arista-cloudvision/><div class=article-image><img src=/p/building-a-datacenter-as-code-with-arista-cloudvision/images/dcac-front.e17c503945054eca9922bcf6fd46b4e7_hu9ac709360588aaaee1a03ffb9aefd712_150968_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Building a DataCenter As Code with Arista CloudVision" data-hash="md5-4XxQOUUFTsqZIrz2/Ua05w=="></div><div class=article-details><h2 class=article-title>Building a DataCenter As Code with Arista CloudVision</h2></div></a></article><article class=has-image><a href=/p/my-first-podcast-interview/><div class=article-image><img src=/p/my-first-podcast-interview/images/cover.232c437fc210a622e0f58f282b3ceb3f_huc2b67065cc238bc9f15887ce24c9ad33_147103_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post My First Podcast Interview" data-hash="md5-IyxDf8IQpiLg9Y8oKzzrPw=="></div><div class=article-details><h2 class=article-title>My First Podcast Interview</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//kaonbytes-com.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2022 -
2024 KaonBytes</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#about>About</a><ol><li><a href=#why-port-scan>Why Port Scan?</a></li><li><a href=#the-tools>The Tools</a></li></ol></li><li><a href=#the-end-result>The End Result</a><ol><li><a href=#generated-report>Generated Report</a></li><li><a href=#ivre-view-database>IVRE View Database</a></li><li><a href=#project-code>Project Code</a></li></ol></li><li><a href=#system-implementation>System Implementation</a><ol><li><a href=#execution-timeline>Execution Timeline</a></li><li><a href=#nmap-options-explained>Nmap Options Explained</a></li><li><a href=#pscan_spawn_jobspy>pscan_spawn_jobs.py</a><ol><li><a href=#ps-auxww>ps auxww</a></li><li><a href=#xml-results-file>xml results file</a></li></ol></li><li><a href=#processing-the-results>Processing the Results</a><ol><li><a href=#import-scan-results-into-ivre-db>Import Scan Results into IVRE DB</a></li><li><a href=#show-most-recent-scan-results-from-db>Show most recent scan results from DB</a></li><li><a href=#show-whats-changed-from-last-scan>Show what&rsquo;s changed from last scan</a></li></ol></li><li><a href=#generating-report-data>Generating Report Data</a><ol><li><a href=#comparing-results-to-desired-state>Comparing Results to Desired State</a></li><li><a href=#creating-the-report>Creating the report</a></li><li><a href=#email-template---jinja2>Email Template - Jinja2</a></li></ol></li></ol></li><li><a href=#end>End</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>