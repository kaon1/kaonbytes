<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='Using Slack slash commands to interact with the Netbox API. Built with a terraform pipeline on AWS API Gateway and Lambda'><title>Slack IPAM Helper</title>
<link rel=canonical href=https://kaonbytes.com/p/slack-ipam-helper/><link rel=stylesheet href=/scss/style.min.450926226e724574a6b936335ea06111f8aeb253d932c86cb2cc807341cd2889.css><meta property='og:title' content='Slack IPAM Helper'><meta property='og:description' content='Using Slack slash commands to interact with the Netbox API. Built with a terraform pipeline on AWS API Gateway and Lambda'><meta property='og:url' content='https://kaonbytes.com/p/slack-ipam-helper/'><meta property='og:site_name' content='KaonBytes'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2023-05-10T00:00:00+00:00'><meta property='article:modified_time' content='2023-05-10T00:00:00+00:00'><meta property='og:image' content='https://kaonbytes.com/p/slack-ipam-helper/images/ipam-helper-front.png'><meta name=twitter:site content="@kaon_123"><meta name=twitter:creator content="@kaon_123"><meta name=twitter:title content="Slack IPAM Helper"><meta name=twitter:description content="Using Slack slash commands to interact with the Netbox API. Built with a terraform pipeline on AWS API Gateway and Lambda"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://kaonbytes.com/p/slack-ipam-helper/images/ipam-helper-front.png'><link rel="shortcut icon" href=favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-LE0JVZ0N09"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LE0JVZ0N09")}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/profile-new_hu0424c52cde2ba37c8617ad2cd064c5ee_88533_300x0_resize_q75_box.jpg width=300 height=450 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>KaonBytes</a></h1><h2 class=site-description>Welcome to my technical blog on all things Networking, Security and Automation</h2></div></header><ol class=social-menu><li><a href=https://github.com/kaon1 target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/kaon1/ target=_blank title=LinkedIn><svg role="img" xmlns="http://www.w3.org/2000/svg" width="1e3mm" height="1e3mm" viewBox="0 0 1e3 1e3" style="max-width:1.6em;height:auto"><path id="path" style="opacity:1;vector-effect:none;fill:#000;fill-opacity:1" d="M336 332s0 457 0 457-125 0-125 0 0-457 0-457 125 0 125 0m10-126s0 0 0 0c0 41-33 74-73 74s-72-33-72-74c0-40 32-73 72-73s73 33 73 73M834 508s0 281 0 281-125 0-125 0 0-233 0-233c0-140-166-129-166 0V789s-124 0-124 0 0-457 0-457 124 0 124 0 0 74 0 74c58-108 291-116 291 102" transform=""/></svg></a></li><li><a href=https://twitter.com/kaonthana target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/_index.zh-cn/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/learning-links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Learning Links</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://kaonbytes.com/ selected>English</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/slack-ipam-helper/><img src=/p/slack-ipam-helper/images/ipam-helper-front_hu0b4c396984346b48c89ef05d3f4ab66d_78125_800x0_resize_box_3.png srcset="/p/slack-ipam-helper/images/ipam-helper-front_hu0b4c396984346b48c89ef05d3f4ab66d_78125_800x0_resize_box_3.png 800w, /p/slack-ipam-helper/images/ipam-helper-front_hu0b4c396984346b48c89ef05d3f4ab66d_78125_1600x0_resize_box_3.png 1600w" width=800 height=311 loading=lazy alt="Featured image of post Slack IPAM Helper"></a></div><div class=article-details><header class=article-category><a href=/categories/cloud/>Cloud
</a><a href=/categories/automation/>Automation
</a><a href=/categories/netbox/>Netbox
</a><a href=/categories/netdevops/>Netdevops
</a><a href=/categories/chatops/>Chatops</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/slack-ipam-helper/>Slack IPAM Helper</a></h2><h3 class=article-subtitle>Using Slack slash commands to interact with the Netbox API. Built with a terraform pipeline on AWS API Gateway and Lambda</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>May 10, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>12 minute read</time></div></footer></div></header><section class=article-content><h2 id=problem>Problem</h2><p>A stakeholder posts a question to the Network Team: &ldquo;Hi, what&rsquo;s the IP Address range for <em>some list of services or sites</em></p><p>Within a few minutes, a senior network greybeard emerges from his lair, dusts off his keyboard and starts typing away retrieving all the IPv4 addresses burned into his hippocampus due to years of on-call PTSD.</p><p>This is a <strong>perfect solution</strong> and we should never improve upon this. HOWEVER, for argument&rsquo;s sake lets say we wanted a more structured and consistent way of providing this information to our stakeholders?</p><h2 id=solution>Solution</h2><p>I built a <a class=link href=https://api.slack.com/ target=_blank rel=noopener>Slack Application</a> which can be invoked with a <strong>slash</strong> command and interacts with <a class=link href=https://github.com/netbox-community/netbox target=_blank rel=noopener>Netbox</a> to retrieve IP Address Management (IPAM) information.</p><p>The application code is hosted on <a class=link href=https://aws.amazon.com/lambda/ target=_blank rel=noopener>AWS Lambda Functions</a> which are triggered by an API Gateway request. The AWS infrastructure is deployed using Infrastructure as Code (IaC) principles with a Github, Drone, Terraform pipeline.</p><p>This blog post is a guide on how you can do it too.</p><h3 id=why-build-it>Why build it?</h3><p>As I mentioned above, some of the most common queries asked of Network Teams are IP Address questions from stakeholders within the organization. Generally relating to, allow list ranges, egress IPs, site and user specific IP addresses for identification. Some examples may include:</p><ul><li>What are the VPN Subnets?</li><li>Can I get a list of all remote site&rsquo;s Internet Egress addresses?</li><li>What are the Wireless Subnets in Site X?</li></ul><p>Instead of relying on shared spreadsheets and/or tribal knowledge which may change based on which engineer is answering the question this week. If we focus our energy on maintaining an accurate single source of truth (SSoT), then we can relay this information back with programmatic efficiency.</p><h3 id=where-to-host-it>Where to host it?</h3><p>It depends.</p><p>Slack is in the public cloud therefore, slash commands, webhooks and bots need to make calls to public endpoints. If your SSoT (in this case Netbox) is not accessible on a public endpoint then what?</p><p>Well, in my case, i&rsquo;m hosting Netbox in a private AWS VPC so the best solution is to create a public AWS API Gateway Endpoint which integrates with an AWS Lambda Function. The lambda function acts as a buffer between the public internet and the Netbox API. Request comes in to the API Gateway, gets forwarded to the lambda, lambda python code performs the logic, talks to Netbox and returns a pretty result for the end user.</p><h2 id=whats-it-look-like>What&rsquo;s it look like?</h2><p>User types <strong>/ipam</strong> in Slack and a menu appears like below:</p><p><img src=/p/slack-ipam-helper/images/menu.png width=1639 height=1324 srcset="/p/slack-ipam-helper/images/menu_hu6a8e8513e52340f96480c49fe9907438_156728_480x0_resize_box_3.png 480w, /p/slack-ipam-helper/images/menu_hu6a8e8513e52340f96480c49fe9907438_156728_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=123 data-flex-basis=297px></p><p><strong>Example 1:</strong> User chooses first radio button and gets back a list of prefixes with descriptions:</p><p><img src=/p/slack-ipam-helper/images/result1.png width=1637 height=1335 srcset="/p/slack-ipam-helper/images/result1_hu30831986a31276c188008bcbb5e21624_249454_480x0_resize_box_3.png 480w, /p/slack-ipam-helper/images/result1_hu30831986a31276c188008bcbb5e21624_249454_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=122 data-flex-basis=294px></p><p><strong>Example 2:</strong> User enters a specific IP Address in the form and presses enter. They get back the full JSON result that Netbox has on that IP Address:</p><p><img src=/p/slack-ipam-helper/images/result2.png width=1635 height=1322 srcset="/p/slack-ipam-helper/images/result2_hu3daeee20fbde20e17a46c67d9f53503d_160592_480x0_resize_box_3.png 480w, /p/slack-ipam-helper/images/result2_hu3daeee20fbde20e17a46c67d9f53503d_160592_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=123 data-flex-basis=296px></p><p><strong>Example 3:</strong> User enters an IP Address that is not known, however is part of a larger prefix. We return information of the parent prefixes:</p><p><img src=/p/slack-ipam-helper/images/result3.png width=1635 height=1326 srcset="/p/slack-ipam-helper/images/result3_huf58ee4a3c61ce1e6f972bcdec1e6d78a_128778_480x0_resize_box_3.png 480w, /p/slack-ipam-helper/images/result3_huf58ee4a3c61ce1e6f972bcdec1e6d78a_128778_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=123 data-flex-basis=295px></p><h3 id=high-level-architecture-diagram>High Level Architecture Diagram</h3><p><img src=/p/slack-ipam-helper/images/ipam-helper-arch.png width=3527 height=2334 srcset="/p/slack-ipam-helper/images/ipam-helper-arch_hu78d2a7a553fb90360d64becd8a1f651f_316380_480x0_resize_box_3.png 480w, /p/slack-ipam-helper/images/ipam-helper-arch_hu78d2a7a553fb90360d64becd8a1f651f_316380_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=151 data-flex-basis=362px></p><h3 id=the-code>The Code</h3><p>All code can be found on my <a class=link href=https://github.com/kaon1/ipam-helper target=_blank rel=noopener>GitHub here</a></p><h3 id=deploying-with-a-terraform-drone-github-pipeline>Deploying with a Terraform, Drone, GitHub Pipeline</h3><p>Why should we use Infrastructure as Code (IaC)?</p><p>We don&rsquo;t want this project to turn into tech debt. IaC helps with this because:</p><ul><li>Allows for version controlled configuration changes</li><li>Self-documents (for the most part)</li><li>Creates an easy-to-follow process for updating and maintaining the application and system environment</li></ul><p>Example Pipeline Run:</p><p><img src=/p/slack-ipam-helper/images/drone1.png width=1718 height=1319 srcset="/p/slack-ipam-helper/images/drone1_hu848b6f363620699dfe57603f70751de7_278586_480x0_resize_box_3.png 480w, /p/slack-ipam-helper/images/drone1_hu848b6f363620699dfe57603f70751de7_278586_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=130 data-flex-basis=312px></p><p>In this post, I am not going to dive deep into the IaC pipeline. If you want to learn more about it, you can follow my previous post: <a class=link href=https://kaonbytes.com/p/bgpalerter-as-code-using-a-terraform-pipeline/ target=_blank rel=noopener>bgpalerter-as-code-using-a-terraform-pipeline</a></p><h2 id=system-components>System Components</h2><h3 id=netbox-ipam-and-tagging>Netbox IPAM and Tagging</h3><p>The key to this whole endeavor is to make sure we <strong>maintain accurate data</strong> in our IPAM. Much of this work will be manual, but it needs to be done somewhere, so its better that these updates are centralized.</p><p>Another way to supplement the IPAM data is to backfill Netbox with data directly from our devices. I have a blog post showing how we can do that <a class=link href=https://kaonbytes.com/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/ target=_blank rel=noopener>here &ndash; netbox-dynamic-inventory-for-ansible-as-a-feedback-loop</a></p><p>In addition to maintaining accurate data, we also need to <strong>tag</strong> the data that we want to relay to our stakeholders. For example, user clicks the <strong>VPN Subnets</strong> button on the slack app, then the data returned should be all prefixes tagged with <strong>vpn_subnets</strong>.</p><p>Example of tagging prefixes in Netbox:</p><p><img src=/p/slack-ipam-helper/images/netbox-tag.png width=1720 height=1328 srcset="/p/slack-ipam-helper/images/netbox-tag_hu3e5b2cdf6dc80c95a55ba3a0ce1f3d51_134248_480x0_resize_box_3.png 480w, /p/slack-ipam-helper/images/netbox-tag_hu3e5b2cdf6dc80c95a55ba3a0ce1f3d51_134248_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=129 data-flex-basis=310px></p><h3 id=slack-api-admin>Slack API Admin</h3><p>Building the Slack App requires access to <a class=link href=https://api.slack.com/start/building target=_blank rel=noopener>https://api.slack.com/start/building</a>. Once you have access, you can start building your app.</p><h4 id=slash-commands>Slash Commands</h4><p>First we can start by creating the <strong>/ipam</strong> slash command as shown here:</p><p><img src=/p/slack-ipam-helper/images/slash1.png width=1720 height=1328 srcset="/p/slack-ipam-helper/images/slash1_hu2d54cf6ef24194f98e46d77685eaf7f4_129484_480x0_resize_box_3.png 480w, /p/slack-ipam-helper/images/slash1_hu2d54cf6ef24194f98e46d77685eaf7f4_129484_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=129 data-flex-basis=310px></p><p>Inside the command, we enter our API Gateway Public Endpoint (we haven&rsquo;t actually created that yet):</p><p><img src=/p/slack-ipam-helper/images/slash2.png width=1720 height=1328 srcset="/p/slack-ipam-helper/images/slash2_hu4fbc73f683e04984d79d5da3a93ab069_88964_480x0_resize_box_3.png 480w, /p/slack-ipam-helper/images/slash2_hu4fbc73f683e04984d79d5da3a93ab069_88964_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=129 data-flex-basis=310px></p><p>The response of this endpoint will be a JSON result which will show our initial menu.</p><h4 id=interactivity--shortcuts>Interactivity & Shortcuts</h4><p>When a user interacts with the initial menu, a new webhook is sent to slack. The destination of this webhook can be configured under Slack &ndash;> Interactivity.
Here we enter our 2nd API Gateway endpoint which points to our second lambda (not configured yet)</p><p><img src=/p/slack-ipam-helper/images/slack-slash-2.png width=1718 height=1319 srcset="/p/slack-ipam-helper/images/slack-slash-2_hu1a1ed026515e91f0bcd55b3177968638_163284_480x0_resize_box_3.png 480w, /p/slack-ipam-helper/images/slack-slash-2_hu1a1ed026515e91f0bcd55b3177968638_163284_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=130 data-flex-basis=312px></p><h4 id=token>Token</h4><p>A verification token is sent along with all slash command payloads. Our Lambda function will parse this token and verify that it is coming from our workspace. This prevents unauthorized users from gaining access to the Netbox data.</p><p>The verification token can be found in your Slack App Admin &ndash;> Basic Information &ndash;> Verification Token</p><h4 id=block-kit-builder>Block Kit Builder</h4><p>Block Kit builder is a visualization tool that slack provides to build your forms and user input fields. The JSON payload can be copied to our lambda function as the returning result of the <strong>/ipam</strong> slash command.</p><p><img src=/p/slack-ipam-helper/images/block-kit.png width=1718 height=1319 srcset="/p/slack-ipam-helper/images/block-kit_hu64fe5b48f296da22cd7e73bd015d1b38_182970_480x0_resize_box_3.png 480w, /p/slack-ipam-helper/images/block-kit_hu64fe5b48f296da22cd7e73bd015d1b38_182970_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=130 data-flex-basis=312px></p><h3 id=amazon-aws-components>Amazon AWS Components</h3><h4 id=api-gateway>API Gateway</h4><p>Terraform Code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_apigatewayv2_api&#34;</span> <span class=s2>&#34;ipam-helper-slack-api&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span>          = <span class=s2>&#34;ipam-helper-slack-api&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>protocol_type</span> = <span class=s2>&#34;HTTP&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_apigatewayv2_integration&#34;</span> <span class=s2>&#34;ipam-get-menu-integration&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>api_id</span>           = <span class=nx>aws_apigatewayv2_api</span><span class=p>.</span><span class=nx>ipam</span><span class=o>-</span><span class=nx>helper</span><span class=o>-</span><span class=nx>slack</span><span class=o>-</span><span class=nx>api</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=na>integration_type</span> = <span class=s2>&#34;AWS_PROXY&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>connection_type</span> = <span class=s2>&#34;INTERNET&#34;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # content_handling_strategy = &#34;CONVERT_TO_TEXT&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=na>description</span>          = <span class=s2>&#34;Ipam Helper Get Menu Integration&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>integration_method</span>   = <span class=s2>&#34;POST&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>integration_uri</span>      = <span class=nx>aws_lambda_function</span><span class=p>.</span><span class=nx>ipam_get_menu</span><span class=p>.</span><span class=nx>invoke_arn</span>
</span></span><span class=line><span class=cl>  <span class=na>passthrough_behavior</span> = <span class=s2>&#34;WHEN_NO_MATCH&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_apigatewayv2_integration&#34;</span> <span class=s2>&#34;ipam-return-action-integration&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>api_id</span>           = <span class=nx>aws_apigatewayv2_api</span><span class=p>.</span><span class=nx>ipam</span><span class=o>-</span><span class=nx>helper</span><span class=o>-</span><span class=nx>slack</span><span class=o>-</span><span class=nx>api</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=na>integration_type</span> = <span class=s2>&#34;AWS_PROXY&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>connection_type</span> = <span class=s2>&#34;INTERNET&#34;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # content_handling_strategy = &#34;CONVERT_TO_TEXT&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=na>description</span>          = <span class=s2>&#34;Ipam Helper Return Action Integration&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>integration_method</span>   = <span class=s2>&#34;POST&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>integration_uri</span>      = <span class=nx>aws_lambda_function</span><span class=p>.</span><span class=nx>ipam_return_action</span><span class=p>.</span><span class=nx>invoke_arn</span>
</span></span><span class=line><span class=cl>  <span class=na>passthrough_behavior</span> = <span class=s2>&#34;WHEN_NO_MATCH&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_apigatewayv2_route&#34;</span> <span class=s2>&#34;ipam-get-menu-route&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>api_id</span>    = <span class=nx>aws_apigatewayv2_api</span><span class=p>.</span><span class=nx>ipam</span><span class=o>-</span><span class=nx>helper</span><span class=o>-</span><span class=nx>slack</span><span class=o>-</span><span class=nx>api</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=na>route_key</span> = <span class=s2>&#34;ANY /ipam_get_menu&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>target</span> = <span class=s2>&#34;integrations/</span><span class=si>${</span><span class=nx>aws_apigatewayv2_integration</span><span class=p>.</span><span class=nx>ipam</span><span class=o>-</span><span class=nx>get</span><span class=o>-</span><span class=nx>menu</span><span class=o>-</span><span class=nx>integration</span><span class=p>.</span><span class=nx>id</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_apigatewayv2_route&#34;</span> <span class=s2>&#34;ipam-return-action-route&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>api_id</span>    = <span class=nx>aws_apigatewayv2_api</span><span class=p>.</span><span class=nx>ipam</span><span class=o>-</span><span class=nx>helper</span><span class=o>-</span><span class=nx>slack</span><span class=o>-</span><span class=nx>api</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=na>route_key</span> = <span class=s2>&#34;ANY /ipam_return_action&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>target</span> = <span class=s2>&#34;integrations/</span><span class=si>${</span><span class=nx>aws_apigatewayv2_integration</span><span class=p>.</span><span class=nx>ipam</span><span class=o>-</span><span class=nx>return</span><span class=o>-</span><span class=nx>action</span><span class=o>-</span><span class=nx>integration</span><span class=p>.</span><span class=nx>id</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_apigatewayv2_stage&#34;</span> <span class=s2>&#34;ipam-helper-slack-api-deploy&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>api_id</span>      = <span class=nx>aws_apigatewayv2_api</span><span class=p>.</span><span class=nx>ipam</span><span class=o>-</span><span class=nx>helper</span><span class=o>-</span><span class=nx>slack</span><span class=o>-</span><span class=nx>api</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span>        = <span class=s2>&#34;default&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>auto_deploy</span> = <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>API GW in GUI:</p><p><img src=/p/slack-ipam-helper/images/api-gw-front.png width=1693 height=782 srcset="/p/slack-ipam-helper/images/api-gw-front_hu5e3811831ca7ebd7dff1866194af9d40_80559_480x0_resize_box_3.png 480w, /p/slack-ipam-helper/images/api-gw-front_hu5e3811831ca7ebd7dff1866194af9d40_80559_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=216 data-flex-basis=519px></p><p>API GW Integrations to Lambdas:</p><p><img src=/p/slack-ipam-helper/images/api-gw-integrations.png width=1696 height=838 srcset="/p/slack-ipam-helper/images/api-gw-integrations_hu6692904db7bc339e453cbc4bf6b46713_109494_480x0_resize_box_3.png 480w, /p/slack-ipam-helper/images/api-gw-integrations_hu6692904db7bc339e453cbc4bf6b46713_109494_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=202 data-flex-basis=485px></p><p>API GW Routes:</p><p><img src=/p/slack-ipam-helper/images/api-gw-routes.png width=1711 height=766 srcset="/p/slack-ipam-helper/images/api-gw-routes_hufd2b261681fe099637ef75e67e489a00_72440_480x0_resize_box_3.png 480w, /p/slack-ipam-helper/images/api-gw-routes_hufd2b261681fe099637ef75e67e489a00_72440_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=223 data-flex-basis=536px></p><h4 id=lambda-1---get-menu>Lambda 1 - Get Menu</h4><p>Terraform:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=kr>data</span> <span class=s2>&#34;archive_file&#34;</span> <span class=s2>&#34;ipam_get_menu&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span>        = <span class=s2>&#34;zip&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>source_dir</span>  = <span class=nb>abspath</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>${</span><span class=nx>path</span><span class=p>.</span><span class=nx>root</span><span class=si>}</span><span class=s2>/../../lambda_ipam_get_menu&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=na>output_path</span> = <span class=nb>abspath</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>${</span><span class=nx>path</span><span class=p>.</span><span class=nx>root</span><span class=si>}</span><span class=s2>/../modules/ipam-helper/lambda_ipam_get_menu.zip&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_iam_role&#34;</span> <span class=s2>&#34;iam_for_ipam_get_menu&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span> = <span class=s2>&#34;iam_for_ipam_get_menu&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>assume_role_policy</span> = <span class=o>&lt;&lt;EOF</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;Statement&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>    {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;Action&#34;: &#34;sts:AssumeRole&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;Principal&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>        &#34;Service&#34;: &#34;lambda.amazonaws.com&#34;
</span></span></span><span class=line><span class=cl><span class=s>      },
</span></span></span><span class=line><span class=cl><span class=s>      &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;Sid&#34;: &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>  ]
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s></span><span class=o>EOF</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_lambda_function&#34;</span> <span class=s2>&#34;ipam_get_menu&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>filename</span>      = <span class=nb>data</span><span class=p>.</span><span class=nx>archive_file</span><span class=p>.</span><span class=nx>ipam_get_menu</span><span class=p>.</span><span class=nx>output_path</span>
</span></span><span class=line><span class=cl>  <span class=na>function_name</span> = <span class=s2>&#34;ipam_get_menu&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>role</span>          = <span class=nx>aws_iam_role</span><span class=p>.</span><span class=nx>iam_for_ipam_get_menu</span><span class=p>.</span><span class=nx>arn</span>
</span></span><span class=line><span class=cl>  <span class=na>handler</span>       = <span class=s2>&#34;lambda_function.lambda_handler&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>source_code_hash</span> = <span class=nb>filebase64sha256</span><span class=p>(</span><span class=nb>data</span><span class=p>.</span><span class=nx>archive_file</span><span class=p>.</span><span class=nx>ipam_get_menu</span><span class=p>.</span><span class=nx>output_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=na>runtime</span>          = <span class=s2>&#34;python3.8&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>timeout</span>          = <span class=m>30</span><span class=c1>  # Time out in second, default value is 3
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=na>memory_size</span>      = <span class=m>128</span><span class=c1> # Default value in MB
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>environment</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>variables</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=na>kmsEncryptedToken</span> = <span class=s2>&#34;replacelater&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=na>depends_on</span> = <span class=p>[</span><span class=nx>aws_cloudwatch_log_group</span><span class=p>.</span><span class=nx>cw_ipam_get_menu</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=na>tags</span>       = <span class=nb>var</span><span class=p>.</span><span class=nx>tags</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_cloudwatch_log_group&#34;</span> <span class=s2>&#34;cw_ipam_get_menu&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span>              = <span class=s2>&#34;/aws/lambda/ipam_get_menu&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>retention_in_days</span> = <span class=m>180</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># See also the following AWS managed policy: AWSLambdaBasicExecutionRole
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;aws_iam_policy&#34;</span> <span class=s2>&#34;ipam_get_menu_lambda_logging&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span>        = <span class=s2>&#34;ipam_get_menu_lambda_logging&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>path</span>        = <span class=s2>&#34;/&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>description</span> = <span class=s2>&#34;IAM policy for logging from a lambda&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>policy</span> = <span class=o>&lt;&lt;EOF</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;Statement&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>    {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;Action&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>        &#34;logs:CreateLogGroup&#34;,
</span></span></span><span class=line><span class=cl><span class=s>        &#34;logs:CreateLogStream&#34;,
</span></span></span><span class=line><span class=cl><span class=s>        &#34;logs:PutLogEvents&#34;
</span></span></span><span class=line><span class=cl><span class=s>      ],
</span></span></span><span class=line><span class=cl><span class=s>      &#34;Resource&#34;: &#34;arn:aws:logs:*:*:*&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;Effect&#34;: &#34;Allow&#34;
</span></span></span><span class=line><span class=cl><span class=s>    },
</span></span></span><span class=line><span class=cl><span class=s>    {
</span></span></span><span class=line><span class=cl><span class=s>        &#34;Sid&#34;: &#34;VisualEditor0&#34;,
</span></span></span><span class=line><span class=cl><span class=s>        &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span class=line><span class=cl><span class=s>        &#34;Action&#34;: &#34;kms:*&#34;,
</span></span></span><span class=line><span class=cl><span class=s>        &#34;Resource&#34;: &#34;*&#34;
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>  ]
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s></span><span class=o>EOF</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_iam_role_policy_attachment&#34;</span> <span class=s2>&#34;ipam_get_menu_lambda_logs&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>role</span>       = <span class=nx>aws_iam_role</span><span class=p>.</span><span class=nx>iam_for_ipam_get_menu</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=na>policy_arn</span> = <span class=nx>aws_iam_policy</span><span class=p>.</span><span class=nx>ipam_get_menu_lambda_logging</span><span class=p>.</span><span class=nx>arn</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_lambda_permission&#34;</span> <span class=s2>&#34;apigw&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>statement_id</span>  = <span class=s2>&#34;AllowAPIGatewayInvoke&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>action</span>        = <span class=s2>&#34;lambda:InvokeFunction&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>function_name</span> = <span class=nx>aws_lambda_function</span><span class=p>.</span><span class=nx>ipam_get_menu</span><span class=p>.</span><span class=nx>function_name</span>
</span></span><span class=line><span class=cl>  <span class=na>principal</span>     = <span class=s2>&#34;apigateway.amazonaws.com&#34;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # The /*/* portion grants access from any method on any resource
</span></span></span><span class=line><span class=cl><span class=c1>  # within the API Gateway &#34;REST API&#34;.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=na>source_arn</span> = <span class=s2>&#34;</span><span class=si>${</span><span class=nx>aws_apigatewayv2_api</span><span class=p>.</span><span class=nx>ipam</span><span class=o>-</span><span class=nx>helper</span><span class=o>-</span><span class=nx>slack</span><span class=o>-</span><span class=nx>api</span><span class=p>.</span><span class=nx>execution_arn</span><span class=si>}</span><span class=s2>/*/*/ipam_get_menu&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Python Code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>boto3</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>base64</span> <span class=kn>import</span> <span class=n>b64decode</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>urllib.parse</span> <span class=kn>import</span> <span class=n>parse_qs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ENCRYPTED_EXPECTED_TOKEN</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s1>&#39;kmsEncryptedToken&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>kms</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;kms&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>expected_token</span> <span class=o>=</span> <span class=n>kms</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>CiphertextBlob</span><span class=o>=</span><span class=n>b64decode</span><span class=p>(</span><span class=n>ENCRYPTED_EXPECTED_TOKEN</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>EncryptionContext</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;LambdaFunctionName&#39;</span><span class=p>:</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s1>&#39;AWS_LAMBDA_FUNCTION_NAME&#39;</span><span class=p>]}</span>
</span></span><span class=line><span class=cl><span class=p>)[</span><span class=s1>&#39;Plaintext&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>respond</span><span class=p>(</span><span class=n>err</span><span class=p>,</span> <span class=n>res</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;statusCode&#39;</span><span class=p>:</span> <span class=s1>&#39;400&#39;</span> <span class=k>if</span> <span class=n>err</span> <span class=k>else</span> <span class=s1>&#39;200&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;body&#39;</span><span class=p>:</span> <span class=n>err</span><span class=o>.</span><span class=n>message</span> <span class=k>if</span> <span class=n>err</span> <span class=k>else</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>res</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf8&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;headers&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Content-Type&#39;</span><span class=p>:</span> <span class=s1>&#39;application/json&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>lambda_handler</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># logger.info(event)</span>
</span></span><span class=line><span class=cl>    <span class=n>decode_body</span> <span class=o>=</span> <span class=n>b64decode</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;body&#39;</span><span class=p>]))</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;ascii&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>parse_qs</span><span class=p>(</span><span class=n>decode_body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>token</span> <span class=o>=</span> <span class=n>params</span><span class=p>[</span><span class=s1>&#39;token&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>token</span> <span class=o>!=</span> <span class=n>expected_token</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=s2>&#34;Request token (</span><span class=si>%s</span><span class=s2>) does not match expected&#34;</span><span class=p>,</span> <span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>respond</span><span class=p>(</span><span class=ne>Exception</span><span class=p>(</span><span class=s1>&#39;Invalid request token&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>f</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;response_menu.json&#39;</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>slack_menu_json</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>respond</span><span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=n>slack_menu_json</span><span class=p>)</span>
</span></span></code></pre></div><p>Console:</p><p><img src=/p/slack-ipam-helper/images/lambda-get-menu.png width=1718 height=1319 srcset="/p/slack-ipam-helper/images/lambda-get-menu_hu60e53b992af48f819e5564e498d1c3a0_151660_480x0_resize_box_3.png 480w, /p/slack-ipam-helper/images/lambda-get-menu_hu60e53b992af48f819e5564e498d1c3a0_151660_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=130 data-flex-basis=312px></p><h4 id=lambda-2---return-data>Lambda 2 - Return Data</h4><p>Terraform:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=kr>data</span> <span class=s2>&#34;archive_file&#34;</span> <span class=s2>&#34;ipam_return_action&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>type</span>        = <span class=s2>&#34;zip&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>source_dir</span>  = <span class=nb>abspath</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>${</span><span class=nx>path</span><span class=p>.</span><span class=nx>root</span><span class=si>}</span><span class=s2>/../../lambda_ipam_return_action&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=na>output_path</span> = <span class=nb>abspath</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>${</span><span class=nx>path</span><span class=p>.</span><span class=nx>root</span><span class=si>}</span><span class=s2>/../modules/ipam-helper/lambda_ipam_return_action.zip&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_iam_role&#34;</span> <span class=s2>&#34;iam_for_ipam_return_action&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span> = <span class=s2>&#34;iam_for_ipam_return_action&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>assume_role_policy</span> = <span class=o>&lt;&lt;EOF</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;Statement&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>    {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;Action&#34;: &#34;sts:AssumeRole&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;Principal&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>        &#34;Service&#34;: &#34;lambda.amazonaws.com&#34;
</span></span></span><span class=line><span class=cl><span class=s>      },
</span></span></span><span class=line><span class=cl><span class=s>      &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;Sid&#34;: &#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>  ]
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s></span><span class=o>EOF</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_lambda_function&#34;</span> <span class=s2>&#34;ipam_return_action&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>filename</span>      = <span class=nb>data</span><span class=p>.</span><span class=nx>archive_file</span><span class=p>.</span><span class=nx>ipam_return_action</span><span class=p>.</span><span class=nx>output_path</span>
</span></span><span class=line><span class=cl>  <span class=na>function_name</span> = <span class=s2>&#34;ipam_return_action&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>role</span>          = <span class=nx>aws_iam_role</span><span class=p>.</span><span class=nx>iam_for_ipam_return_action</span><span class=p>.</span><span class=nx>arn</span>
</span></span><span class=line><span class=cl>  <span class=na>handler</span>       = <span class=s2>&#34;lambda_function.lambda_handler&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>source_code_hash</span> = <span class=nb>filebase64sha256</span><span class=p>(</span><span class=nb>data</span><span class=p>.</span><span class=nx>archive_file</span><span class=p>.</span><span class=nx>ipam_return_action</span><span class=p>.</span><span class=nx>output_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=na>runtime</span>          = <span class=s2>&#34;python3.8&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>timeout</span>          = <span class=m>30</span><span class=c1>  # Time out in second, default value is 3
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=na>memory_size</span>      = <span class=m>128</span><span class=c1> # Default value in MB
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>vpc_config</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>subnet_ids</span>         = <span class=p>[</span><span class=s2>&#34;&lt;subnet1&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;&lt;subnet2&gt;&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=na>security_group_ids</span> = <span class=p>[</span><span class=nx>aws_security_group</span><span class=p>.</span><span class=nx>lambda_slackbot_sg</span><span class=p>.</span><span class=nx>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>environment</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>variables</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=na>kmsEncryptedToken</span> = <span class=s2>&#34;replacelater&#34;</span>
</span></span><span class=line><span class=cl>      <span class=na>NETBOX_TOKEN</span>      = <span class=s2>&#34;replacelater&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=na>depends_on</span> = <span class=p>[</span><span class=nx>aws_cloudwatch_log_group</span><span class=p>.</span><span class=nx>cw_ipam_return_action</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=na>tags</span>       = <span class=nb>var</span><span class=p>.</span><span class=nx>tags</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_cloudwatch_log_group&#34;</span> <span class=s2>&#34;cw_ipam_return_action&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span>              = <span class=s2>&#34;/aws/lambda/ipam_return_action&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>retention_in_days</span> = <span class=m>180</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1># See also the following AWS managed policy: AWSLambdaBasicExecutionRole
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>resource</span> <span class=s2>&#34;aws_iam_policy&#34;</span> <span class=s2>&#34;ipam_return_action_lambda_logging&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>name</span>        = <span class=s2>&#34;ipam_return_action_lambda_logging&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>path</span>        = <span class=s2>&#34;/&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>description</span> = <span class=s2>&#34;IAM policy for logging from a lambda&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>policy</span> = <span class=o>&lt;&lt;EOF</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;Statement&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>    {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;Action&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>        &#34;logs:CreateLogGroup&#34;,
</span></span></span><span class=line><span class=cl><span class=s>        &#34;logs:CreateLogStream&#34;,
</span></span></span><span class=line><span class=cl><span class=s>        &#34;logs:PutLogEvents&#34;
</span></span></span><span class=line><span class=cl><span class=s>      ],
</span></span></span><span class=line><span class=cl><span class=s>      &#34;Resource&#34;: &#34;arn:aws:logs:*:*:*&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;Effect&#34;: &#34;Allow&#34;
</span></span></span><span class=line><span class=cl><span class=s>    },
</span></span></span><span class=line><span class=cl><span class=s>    {
</span></span></span><span class=line><span class=cl><span class=s>        &#34;Sid&#34;: &#34;VisualEditor0&#34;,
</span></span></span><span class=line><span class=cl><span class=s>        &#34;Effect&#34;: &#34;Allow&#34;,
</span></span></span><span class=line><span class=cl><span class=s>        &#34;Action&#34;: &#34;kms:*&#34;,
</span></span></span><span class=line><span class=cl><span class=s>        &#34;Resource&#34;: &#34;*&#34;
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>  ]
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s></span><span class=o>EOF</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_iam_role_policy_attachment&#34;</span> <span class=s2>&#34;ipam_return_action_lambda_logs&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>role</span>       = <span class=nx>aws_iam_role</span><span class=p>.</span><span class=nx>iam_for_ipam_return_action</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=na>policy_arn</span> = <span class=nx>aws_iam_policy</span><span class=p>.</span><span class=nx>ipam_return_action_lambda_logging</span><span class=p>.</span><span class=nx>arn</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_lambda_permission&#34;</span> <span class=s2>&#34;apigw_2&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>statement_id</span>  = <span class=s2>&#34;AllowAPIGatewayInvoke&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>action</span>        = <span class=s2>&#34;lambda:InvokeFunction&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>function_name</span> = <span class=nx>aws_lambda_function</span><span class=p>.</span><span class=nx>ipam_return_action</span><span class=p>.</span><span class=nx>function_name</span>
</span></span><span class=line><span class=cl>  <span class=na>principal</span>     = <span class=s2>&#34;apigateway.amazonaws.com&#34;</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # The /*/* portion grants access from any method on any resource
</span></span></span><span class=line><span class=cl><span class=c1>  # within the API Gateway &#34;REST API&#34;.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=na>source_arn</span> = <span class=s2>&#34;</span><span class=si>${</span><span class=nx>aws_apigatewayv2_api</span><span class=p>.</span><span class=nx>ipam</span><span class=o>-</span><span class=nx>helper</span><span class=o>-</span><span class=nx>slack</span><span class=o>-</span><span class=nx>api</span><span class=p>.</span><span class=nx>execution_arn</span><span class=si>}</span><span class=s2>/*/*/ipam_return_action&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_iam_role_policy_attachment&#34;</span> <span class=s2>&#34;iam_role_policy_attachment_lambda_vpc_access_execution&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>role</span>       = <span class=nx>aws_iam_role</span><span class=p>.</span><span class=nx>iam_for_ipam_return_action</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>  <span class=na>policy_arn</span> = <span class=s2>&#34;arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;aws_security_group&#34;</span> <span class=s2>&#34;lambda_slackbot_sg&#34;</span> <span class=p>{</span><span class=c1>
</span></span></span><span class=line><span class=cl><span class=c1>  # provider    = aws.us-east-1
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=na>name</span>        = <span class=s2>&#34;lambda_slackbot_sg&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>description</span> = <span class=s2>&#34;Security Group to manage lambda_slackbot access&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>vpc_id</span>      = <span class=nb>data</span><span class=p>.</span><span class=nx>terraform_remote_state</span><span class=p>.</span><span class=nx>account_base</span><span class=p>.</span><span class=nx>outputs</span><span class=p>.</span><span class=nx>vpc_east_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>ingress</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>from_port</span>   = <span class=m>80</span>
</span></span><span class=line><span class=cl>    <span class=na>to_port</span>     = <span class=m>80</span>
</span></span><span class=line><span class=cl>    <span class=na>protocol</span>    = <span class=s2>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>cidr_blocks</span> = <span class=p>[</span><span class=s2>&#34;10.0.0.0/8&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>ingress</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>from_port</span>   = <span class=m>443</span>
</span></span><span class=line><span class=cl>    <span class=na>to_port</span>     = <span class=m>443</span>
</span></span><span class=line><span class=cl>    <span class=na>protocol</span>    = <span class=s2>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>cidr_blocks</span> = <span class=p>[</span><span class=s2>&#34;10.0.0.0/8&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>ingress</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>from_port</span>   = <span class=m>-1</span>
</span></span><span class=line><span class=cl>    <span class=na>to_port</span>     = <span class=m>-1</span>
</span></span><span class=line><span class=cl>    <span class=na>protocol</span>    = <span class=s2>&#34;icmp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>cidr_blocks</span> = <span class=p>[</span><span class=s2>&#34;10.0.0.0/8&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>egress</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>from_port</span>   = <span class=m>0</span>
</span></span><span class=line><span class=cl>    <span class=na>to_port</span>     = <span class=m>0</span>
</span></span><span class=line><span class=cl>    <span class=na>protocol</span>    = <span class=s2>&#34;-1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>cidr_blocks</span> = <span class=p>[</span><span class=s2>&#34;0.0.0.0/0&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Python Code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>boto3</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>ipaddress</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>urllib.parse</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pprint</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>base64</span> <span class=kn>import</span> <span class=n>b64decode</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>urllib.parse</span> <span class=kn>import</span> <span class=n>parse_qs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ENCRYPTED_EXPECTED_TOKEN</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s1>&#39;kmsEncryptedToken&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>NETBOX_TOKEN</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s1>&#39;NETBOX_TOKEN&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>netbox_url</span> <span class=o>=</span> <span class=s1>&#39;&lt;redacted&gt;&#39;</span>
</span></span><span class=line><span class=cl><span class=n>netbox_headers</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;Authorization&#39;</span><span class=p>:</span> <span class=s2>&#34;Token </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>NETBOX_TOKEN</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>kms</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;kms&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>expected_token</span> <span class=o>=</span> <span class=n>kms</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>CiphertextBlob</span><span class=o>=</span><span class=n>b64decode</span><span class=p>(</span><span class=n>ENCRYPTED_EXPECTED_TOKEN</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>EncryptionContext</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;LambdaFunctionName&#39;</span><span class=p>:</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s1>&#39;AWS_LAMBDA_FUNCTION_NAME&#39;</span><span class=p>]}</span>
</span></span><span class=line><span class=cl><span class=p>)[</span><span class=s1>&#39;Plaintext&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>logger</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>respond</span><span class=p>(</span><span class=n>err</span><span class=p>,</span> <span class=n>res</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;statusCode&#39;</span><span class=p>:</span> <span class=s1>&#39;400&#39;</span> <span class=k>if</span> <span class=n>err</span> <span class=k>else</span> <span class=s1>&#39;200&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;body&#39;</span><span class=p>:</span> <span class=n>err</span><span class=o>.</span><span class=n>message</span> <span class=k>if</span> <span class=n>err</span> <span class=k>else</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>res</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf8&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;headers&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;Content-Type&#39;</span><span class=p>:</span> <span class=s1>&#39;application/json&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>netbox_return_prefixes</span><span class=p>(</span><span class=n>tag</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ipam_api_call</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>netbox_url</span><span class=o>+</span><span class=s2>&#34;/api/ipam/prefixes/?limit=0&amp;tag=&#34;</span><span class=o>+</span><span class=n>tag</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>netbox_headers</span><span class=p>,</span> <span class=n>verify</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ipam_api_call</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;results&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>netbox_return_addresses</span><span class=p>(</span><span class=n>tag</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ipam_api_call</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>netbox_url</span><span class=o>+</span><span class=s2>&#34;/api/ipam/ip-addresses/?limit=0&amp;tag=&#34;</span><span class=o>+</span><span class=n>tag</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>netbox_headers</span><span class=p>,</span> <span class=n>verify</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ipam_api_call</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;results&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>netbox_return_ranges</span><span class=p>(</span><span class=n>tag</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ipam_api_call</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>netbox_url</span><span class=o>+</span><span class=s2>&#34;/api/ipam/ip-ranges/?limit=0&amp;tag=&#34;</span><span class=o>+</span><span class=n>tag</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>netbox_headers</span><span class=p>,</span> <span class=n>verify</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ipam_api_call</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;results&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>netbox_return_prefix_input</span><span class=p>(</span><span class=nb>input</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ipam_api_call</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>netbox_url</span><span class=o>+</span><span class=s2>&#34;/api/ipam/prefixes/?limit=0&amp;prefix=&#34;</span><span class=o>+</span><span class=nb>input</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>netbox_headers</span><span class=p>,</span> <span class=n>verify</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ipam_api_call</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;results&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>netbox_return_address_input</span><span class=p>(</span><span class=nb>input</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ipam_api_call</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>netbox_url</span><span class=o>+</span><span class=s2>&#34;/api/ipam/ip-addresses/?limit=0&amp;address=&#34;</span><span class=o>+</span><span class=nb>input</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>netbox_headers</span><span class=p>,</span> <span class=n>verify</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ipam_api_call</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;results&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>netbox_return_prefix_contains_input</span><span class=p>(</span><span class=nb>input</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ipam_api_call</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>netbox_url</span><span class=o>+</span><span class=s2>&#34;/api/ipam/prefixes/?limit=0&amp;contains=&#34;</span><span class=o>+</span><span class=nb>input</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>netbox_headers</span><span class=p>,</span> <span class=n>verify</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ipam_api_call</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;results&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_ephemeral_message</span><span class=p>(</span><span class=n>response_url</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ephemeral_headers</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;Content-Type&#39;</span><span class=p>:</span> <span class=s1>&#39;application/json&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1># logger.info(response_url)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>response_url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>ephemeral_headers</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>action_get_public_nat</span><span class=p>(</span><span class=n>tag</span><span class=o>=</span><span class=s2>&#34;public_egress&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>public_nat_prefixes</span> <span class=o>=</span> <span class=n>netbox_return_prefixes</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>public_nat_ranges</span> <span class=o>=</span> <span class=n>netbox_return_ranges</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>public_nat_addresses</span> <span class=o>=</span> <span class=n>netbox_return_addresses</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ephemeral_response_text</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>prefix</span> <span class=ow>in</span> <span class=n>public_nat_prefixes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ephemeral_response_text</span> <span class=o>+=</span> <span class=s2>&#34;Prefix --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>prefix</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;prefix&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34; | Description --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>prefix</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;description&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nb>range</span> <span class=ow>in</span> <span class=n>public_nat_ranges</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ephemeral_response_text</span> <span class=o>+=</span> <span class=s2>&#34;Range --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=nb>range</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;display&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34; | Description --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=nb>range</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;description&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>address</span> <span class=ow>in</span> <span class=n>public_nat_addresses</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ephemeral_response_text</span> <span class=o>+=</span> <span class=s2>&#34;Address --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>address</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;address&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34; | Description --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>address</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;description&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ephemeral_response_text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>action_get_trusted_user_subnet</span><span class=p>(</span><span class=n>tag</span><span class=o>=</span><span class=s2>&#34;wireless_user_subnet&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>trusted_user_prefixes</span> <span class=o>=</span> <span class=n>netbox_return_prefixes</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>trusted_user_ranges</span> <span class=o>=</span> <span class=n>netbox_return_ranges</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>trusted_user_addresses</span> <span class=o>=</span> <span class=n>netbox_return_addresses</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ephemeral_response_text</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>prefix</span> <span class=ow>in</span> <span class=n>trusted_user_prefixes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ephemeral_response_text</span> <span class=o>+=</span> <span class=s2>&#34;Prefix --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>prefix</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;prefix&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34; | Description --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>prefix</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;description&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nb>range</span> <span class=ow>in</span> <span class=n>trusted_user_ranges</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ephemeral_response_text</span> <span class=o>+=</span> <span class=s2>&#34;Range --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=nb>range</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;display&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34; | Description --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=nb>range</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;description&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>address</span> <span class=ow>in</span> <span class=n>trusted_user_addresses</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ephemeral_response_text</span> <span class=o>+=</span> <span class=s2>&#34;Address --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>address</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;address&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34; | Description --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>address</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;description&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ephemeral_response_text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>action_get_tagged_subnet</span><span class=p>(</span><span class=n>tag</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>trusted_user_prefixes</span> <span class=o>=</span> <span class=n>netbox_return_prefixes</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>trusted_user_ranges</span> <span class=o>=</span> <span class=n>netbox_return_ranges</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>trusted_user_addresses</span> <span class=o>=</span> <span class=n>netbox_return_addresses</span><span class=p>(</span><span class=n>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ephemeral_response_text</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>prefix</span> <span class=ow>in</span> <span class=n>trusted_user_prefixes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ephemeral_response_text</span> <span class=o>+=</span> <span class=s2>&#34;Prefix --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>prefix</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;prefix&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34; | Description --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>prefix</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;description&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nb>range</span> <span class=ow>in</span> <span class=n>trusted_user_ranges</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ephemeral_response_text</span> <span class=o>+=</span> <span class=s2>&#34;Range --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=nb>range</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;display&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34; | Description --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=nb>range</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;description&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>address</span> <span class=ow>in</span> <span class=n>trusted_user_addresses</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ephemeral_response_text</span> <span class=o>+=</span> <span class=s2>&#34;Address --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>address</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;address&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34; | Description --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>address</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;description&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ephemeral_response_text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>action_get_more_info</span><span class=p>(</span><span class=n>user_input</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>prefix_info</span> <span class=o>=</span> <span class=n>netbox_return_prefix_input</span><span class=p>(</span><span class=n>user_input</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>address_info</span> <span class=o>=</span> <span class=n>netbox_return_address_input</span><span class=p>(</span><span class=n>user_input</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>prefix_contains_info</span> <span class=o>=</span> <span class=n>netbox_return_prefix_contains_input</span><span class=p>(</span><span class=n>user_input</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># logger.info(user_input)</span>
</span></span><span class=line><span class=cl>    <span class=c1># logger.info(prefix_info)</span>
</span></span><span class=line><span class=cl>    <span class=c1># logger.info(address_info)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ephemeral_response_text</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>prefix_info</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>prefix_info</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># ephemeral_response_text += &#34;Prefix --&gt; &#34;+str(prefix_info[0].get(&#39;prefix&#39;))+&#34; | Description --&gt; &#34;+str(prefix_info[0].get(&#39;description&#39;))+&#34;\n&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>ephemeral_response_text</span> <span class=o>=</span> <span class=n>pprint</span><span class=o>.</span><span class=n>pformat</span><span class=p>(</span><span class=n>prefix_info</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>indent</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>address_info</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>address_info</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># ephemeral_response_text += &#34;Address --&gt; &#34;+str(address_info[0].get(&#39;address&#39;))+&#34; | Description --&gt; &#34;+str(address_info[0].get(&#39;description&#39;))+&#34;\n&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>ephemeral_response_text</span> <span class=o>=</span> <span class=n>pprint</span><span class=o>.</span><span class=n>pformat</span><span class=p>(</span><span class=n>address_info</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>indent</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>prefix_contains_info</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>prefix_contains_info</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ephemeral_response_text</span> <span class=o>+=</span> <span class=s2>&#34;Specific entry not found but is contained in the following Prefixes:</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>prefix_contains_info</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>ephemeral_response_text</span> <span class=o>+=</span> <span class=s2>&#34;Prefix --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;prefix&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34; | Description --&gt; &#34;</span><span class=o>+</span><span class=nb>str</span><span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;description&#39;</span><span class=p>))</span><span class=o>+</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ephemeral_response_text</span> <span class=o>=</span> <span class=s2>&#34;No Information Found for This Entry --&gt; &#34;</span><span class=o>+</span><span class=n>user_input</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ephemeral_response_text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>lambda_handler</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># logger.info(event)</span>
</span></span><span class=line><span class=cl>    <span class=n>decode_body</span> <span class=o>=</span> <span class=n>b64decode</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;body&#39;</span><span class=p>]))</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;ascii&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=n>parse_qs</span><span class=p>(</span><span class=n>decode_body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>payload_dict</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>params</span><span class=p>[</span><span class=s1>&#39;payload&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=c1># logger.info(payload_dict)</span>
</span></span><span class=line><span class=cl>    <span class=c1># logger.info(type(payload_dict))</span>
</span></span><span class=line><span class=cl>    <span class=n>token</span> <span class=o>=</span> <span class=n>payload_dict</span><span class=p>[</span><span class=s1>&#39;token&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>token</span> <span class=o>!=</span> <span class=n>expected_token</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=s2>&#34;Request token (</span><span class=si>%s</span><span class=s2>) does not match expected&#34;</span><span class=p>,</span> <span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>respond</span><span class=p>(</span><span class=ne>Exception</span><span class=p>(</span><span class=s1>&#39;Invalid request token&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># logger.info(payload_dict[&#39;actions&#39;][0][&#39;value&#39;])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>payload_dict</span><span class=p>[</span><span class=s1>&#39;actions&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=s1>&#39;value&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;public_egress&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ephemeral_response_body</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=n>action_get_public_nat</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>payload_dict</span><span class=p>[</span><span class=s1>&#39;actions&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=s1>&#39;value&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;wireless_user_subnet&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ephemeral_response_body</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=n>action_get_trusted_user_subnet</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>payload_dict</span><span class=p>[</span><span class=s1>&#39;actions&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=s1>&#39;value&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;vpn_subnet&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ephemeral_response_body</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=n>action_get_tagged_subnet</span><span class=p>(</span><span class=n>payload_dict</span><span class=p>[</span><span class=s1>&#39;actions&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=s1>&#39;value&#39;</span><span class=p>])}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>payload_dict</span><span class=p>[</span><span class=s1>&#39;actions&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=s1>&#39;action_id&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;plain_text_input-action&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>user_input</span> <span class=o>=</span> <span class=n>payload_dict</span><span class=p>[</span><span class=s1>&#39;actions&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=s1>&#39;value&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>user_input_validated</span> <span class=o>=</span> <span class=n>ipaddress</span><span class=o>.</span><span class=n>ip_interface</span><span class=p>(</span><span class=n>user_input</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>user_input_encoded</span> <span class=o>=</span> <span class=n>urllib</span><span class=o>.</span><span class=n>parse</span><span class=o>.</span><span class=n>quote</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>user_input</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>ephemeral_response_body</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=n>action_get_more_info</span><span class=p>(</span><span class=n>user_input_encoded</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>ValueError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>ephemeral_response_body</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=s2>&#34;You entered an Unrecognized IP or Prefix - Please Enter in the Format of 10.10.10.1 or 10.10.10.0/24&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>send_msg</span> <span class=o>=</span> <span class=n>send_ephemeral_message</span><span class=p>(</span><span class=n>payload_dict</span><span class=p>[</span><span class=s1>&#39;response_url&#39;</span><span class=p>],</span> <span class=n>ephemeral_response_body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>send_msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>api_response</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=s2>&#34;okay&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>respond</span><span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=n>api_response</span><span class=p>)</span>
</span></span></code></pre></div><p>Console:</p><p><img src=/p/slack-ipam-helper/images/lambda-menu-action.png width=1718 height=1319 srcset="/p/slack-ipam-helper/images/lambda-menu-action_hu3d830751a0c36f61e0dfe07f2ee0f5b0_170477_480x0_resize_box_3.png 480w, /p/slack-ipam-helper/images/lambda-menu-action_hu3d830751a0c36f61e0dfe07f2ee0f5b0_170477_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=130 data-flex-basis=312px></p><h4 id=encrypting-the-slack-token>Encrypting the Slack Token</h4><p>We can encrypt the Slack verification token using AWS KMS Encryption.
To encrypt your token use the following steps:</p><ol><li><p>Create or use an existing KMS Key - <a class=link href=http://docs.aws.amazon.com/kms/latest/developerguide/create-keys.html target=_blank rel=noopener>http://docs.aws.amazon.com/kms/latest/developerguide/create-keys.html</a></p></li><li><p>Expand &ldquo;Encryption configuration&rdquo; and click the &ldquo;Enable helpers for encryption in transit&rdquo; checkbox</p></li><li><p>Paste &lt;COMMAND_TOKEN> into the kmsEncryptedToken environment variable and click &ldquo;Encrypt&rdquo;</p></li><li><p>Give your function&rsquo;s role permission for the <code>kms:Decrypt</code> action using the provided policy template</p></li></ol><p>The encrypted token will look something like this:</p><p><img src=/p/slack-ipam-helper/images/kms.png width=919 height=777 srcset="/p/slack-ipam-helper/images/kms_huf0ea47ccaa61d773f9c67006ab736761_82627_480x0_resize_box_3.png 480w, /p/slack-ipam-helper/images/kms_huf0ea47ccaa61d773f9c67006ab736761_82627_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=118 data-flex-basis=283px></p><h2 id=conclusion---next-steps>Conclusion - Next Steps?</h2><p>Future improvements for this app may include:</p><ul><li>Additional inputs, create drop down lists instead of buttons</li><li>Auto-responder (instead of requiring slash command input)</li><li>Move away from ephemeral messages to persistent messages</li></ul><p>Thanks for following along, cheers!</p></section><footer class=article-footer></footer></article><aside class=related-contents--wrapper><h2 class=section-title>Related contents</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/p/perimeter-scanner/><div class=article-image><img src=/p/perimeter-scanner/images/_huda0cd6a7d1bad9baa374d7c905f6581c_150841_cee306edb530dd7aacf110c4b122eae5.png width=250 height=150 loading=lazy alt="Featured image of post Perimeter Scanner" data-hash="md5-Fer5VqTVcgkOKzCypd0HjQ=="></div><div class=article-details><h2 class=article-title>Perimeter Scanner</h2></div></a></article><article class=has-image><a href=/p/golden-configuration-deployment-with-ansible-and-netbox/><div class=article-image><img src=/p/golden-configuration-deployment-with-ansible-and-netbox/golden-config-front.0a95a4dbc7df190c14802b057fde04f9_hu3972f5f5b3bf12cabffe22f75756d981_1247419_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Golden Configuration Deployment with Ansible and Netbox" data-hash="md5-CpWk28ffGQwUgCsFf94E+Q=="></div><div class=article-details><h2 class=article-title>Golden Configuration Deployment with Ansible and Netbox</h2></div></a></article><article class=has-image><a href=/p/ansible-configuration-backup-manager/><div class=article-image><img src=/p/ansible-configuration-backup-manager/_hu12225e3f406182c91634608ad7cb2c64_1239508_1af7a87b45fb3b73a9c1c716fe9eb0f9.png width=250 height=150 loading=lazy alt="Featured image of post Ansible Configuration Backup Manager" data-hash="md5-+TQ8PJ8mkUygm6V0xYsxfQ=="></div><div class=article-details><h2 class=article-title>Ansible Configuration Backup Manager</h2></div></a></article><article class=has-image><a href=/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/><div class=article-image><img src=/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/_hu91008c89e08c35be24c68bc187db22be_244905_6b7b6c28489eabc0762e130a45e366ac.png width=250 height=150 loading=lazy alt="Featured image of post Netbox Dynamic Inventory for Ansible as a feedback loop" data-hash="md5-isvFNqFle3F1LJV2T6/Njg=="></div><div class=article-details><h2 class=article-title>Netbox Dynamic Inventory for Ansible as a feedback loop</h2></div></a></article><article class=has-image><a href=/p/a-case-study-in-hybrid-cloud-network-design/><div class=article-image><img src=/p/a-case-study-in-hybrid-cloud-network-design/images/front2.4f619109542b6500dbd4fdd5aa6dab84_hu9bcde3317be3c40344c69cb562d5c034_33248_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post A Case Study in Hybrid Cloud Network Design" data-hash="md5-T2GRCVQrZQDb1P3Vqm2rhA=="></div><div class=article-details><h2 class=article-title>A Case Study in Hybrid Cloud Network Design</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//kaonbytes-com.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2022 -
2024 KaonBytes</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#problem>Problem</a></li><li><a href=#solution>Solution</a><ol><li><a href=#why-build-it>Why build it?</a></li><li><a href=#where-to-host-it>Where to host it?</a></li></ol></li><li><a href=#whats-it-look-like>What&rsquo;s it look like?</a><ol><li><a href=#high-level-architecture-diagram>High Level Architecture Diagram</a></li><li><a href=#the-code>The Code</a></li><li><a href=#deploying-with-a-terraform-drone-github-pipeline>Deploying with a Terraform, Drone, GitHub Pipeline</a></li></ol></li><li><a href=#system-components>System Components</a><ol><li><a href=#netbox-ipam-and-tagging>Netbox IPAM and Tagging</a></li><li><a href=#slack-api-admin>Slack API Admin</a><ol><li><a href=#slash-commands>Slash Commands</a></li><li><a href=#interactivity--shortcuts>Interactivity & Shortcuts</a></li><li><a href=#token>Token</a></li><li><a href=#block-kit-builder>Block Kit Builder</a></li></ol></li><li><a href=#amazon-aws-components>Amazon AWS Components</a><ol><li><a href=#api-gateway>API Gateway</a></li><li><a href=#lambda-1---get-menu>Lambda 1 - Get Menu</a></li><li><a href=#lambda-2---return-data>Lambda 2 - Return Data</a></li><li><a href=#encrypting-the-slack-token>Encrypting the Slack Token</a></li></ol></li></ol></li><li><a href=#conclusion---next-steps>Conclusion - Next Steps?</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>