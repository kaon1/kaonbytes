<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='Leverage NetDevOps tools such as Netbox, ContainerLab, and Ansible to deploy and manage an Arista Datacenter with CloudVision'><title>Building a DataCenter As Code with Arista CloudVision</title>
<link rel=canonical href=https://kaonbytes.com/p/building-a-datacenter-as-code-with-arista-cloudvision/><link rel=stylesheet href=/scss/style.min.450926226e724574a6b936335ea06111f8aeb253d932c86cb2cc807341cd2889.css><meta property='og:title' content='Building a DataCenter As Code with Arista CloudVision'><meta property='og:description' content='Leverage NetDevOps tools such as Netbox, ContainerLab, and Ansible to deploy and manage an Arista Datacenter with CloudVision'><meta property='og:url' content='https://kaonbytes.com/p/building-a-datacenter-as-code-with-arista-cloudvision/'><meta property='og:site_name' content='KaonBytes'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2023-08-31T00:00:00+00:00'><meta property='article:modified_time' content='2023-08-31T00:00:00+00:00'><meta property='og:image' content='https://kaonbytes.com/p/building-a-datacenter-as-code-with-arista-cloudvision/images/dcac-front.png'><meta name=twitter:site content="@kaon_123"><meta name=twitter:creator content="@kaon_123"><meta name=twitter:title content="Building a DataCenter As Code with Arista CloudVision"><meta name=twitter:description content="Leverage NetDevOps tools such as Netbox, ContainerLab, and Ansible to deploy and manage an Arista Datacenter with CloudVision"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://kaonbytes.com/p/building-a-datacenter-as-code-with-arista-cloudvision/images/dcac-front.png'><link rel="shortcut icon" href=favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-LE0JVZ0N09"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LE0JVZ0N09")}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/profile-new_hu0424c52cde2ba37c8617ad2cd064c5ee_88533_300x0_resize_q75_box.jpg width=300 height=450 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>KaonBytes</a></h1><h2 class=site-description>Welcome to my technical blog on all things Networking, Security and Automation</h2></div></header><ol class=social-menu><li><a href=https://github.com/kaon1 target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.linkedin.com/in/kaon1/ target=_blank title=LinkedIn><svg role="img" xmlns="http://www.w3.org/2000/svg" width="1e3mm" height="1e3mm" viewBox="0 0 1e3 1e3" style="max-width:1.6em;height:auto"><path id="path" style="opacity:1;vector-effect:none;fill:#000;fill-opacity:1" d="M336 332s0 457 0 457-125 0-125 0 0-457 0-457 125 0 125 0m10-126s0 0 0 0c0 41-33 74-73 74s-72-33-72-74c0-40 32-73 72-73s73 33 73 73M834 508s0 281 0 281-125 0-125 0 0-233 0-233c0-140-166-129-166 0V789s-124 0-124 0 0-457 0-457 124 0 124 0 0 74 0 74c58-108 291-116 291 102" transform=""/></svg></a></li><li><a href=https://twitter.com/kaonthana target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/_index.zh-cn/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/learning-links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Learning Links</span></a></li><div class=menu-bottom-section><li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://kaonbytes.com/ selected>English</option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/building-a-datacenter-as-code-with-arista-cloudvision/><img src=/p/building-a-datacenter-as-code-with-arista-cloudvision/images/dcac-front_hu9ac709360588aaaee1a03ffb9aefd712_150968_800x0_resize_box_3.png srcset="/p/building-a-datacenter-as-code-with-arista-cloudvision/images/dcac-front_hu9ac709360588aaaee1a03ffb9aefd712_150968_800x0_resize_box_3.png 800w, /p/building-a-datacenter-as-code-with-arista-cloudvision/images/dcac-front_hu9ac709360588aaaee1a03ffb9aefd712_150968_1600x0_resize_box_3.png 1600w" width=800 height=311 loading=lazy alt="Featured image of post Building a DataCenter As Code with Arista CloudVision"></a></div><div class=article-details><header class=article-category><a href=/categories/ansible/>Ansible
</a><a href=/categories/arista/>Arista
</a><a href=/categories/containerlab/>Containerlab
</a><a href=/categories/netdevops/>Netdevops
</a><a href=/categories/netbox/>Netbox</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/building-a-datacenter-as-code-with-arista-cloudvision/>Building a DataCenter As Code with Arista CloudVision</a></h2><h3 class=article-subtitle>Leverage NetDevOps tools such as Netbox, ContainerLab, and Ansible to deploy and manage an Arista Datacenter with CloudVision</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Aug 31, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>5 minute read</time></div></footer></div></header><section class=article-content><h2 id=about>About</h2><p>I recently worked on a project using <a class=link href=https://en.wikipedia.org/wiki/Arista_Networks target=_blank rel=noopener>Arista</a> Network switches and <a class=link href=https://www.arista.com/en/products/eos/eos-cloudvision target=_blank rel=noopener>Arista CloudVision</a> in the datacenter. As a greenfield deployment, I thought it would be a good opportunity to combine multiple netdevops techniques and tools to create a complete data-center-as-code pipeline to manage this deployment.</p><p>The code I will be referencing can all be <a class=link href=https://github.com/kaon1/datacenter-as-code-arista-cloudvision target=_blank rel=noopener>found here on my personal GitHub</a>.</p><h2 id=pipeline>Pipeline</h2><p>The Pipeline looks something like this:</p><ol><li>Commit desired configuration changes to source control (GitHub)</li><li>Render intended configurations</li><li>Use Ansible to upload these configurations to CloudVision</li><li>Use Ansible to interact with CloudVision, create and execute a change control</li><li>Deploy to Digital Twin (staging environment) built by <a class=link href=https://containerlab.dev/ target=_blank rel=noopener>ContainerLab</a></li><li>Run post-check assurance testing to validate state</li><li>Deploy to Production</li></ol><p><img src=/p/building-a-datacenter-as-code-with-arista-cloudvision/images/pipeline.png width=3356 height=3523 srcset="/p/building-a-datacenter-as-code-with-arista-cloudvision/images/pipeline_hua04efc27d7ecccf8912e5bca2295e7fb_707013_480x0_resize_box_3.png 480w, /p/building-a-datacenter-as-code-with-arista-cloudvision/images/pipeline_hua04efc27d7ecccf8912e5bca2295e7fb_707013_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=95 data-flex-basis=228px></p><h2 id=walkthrough>Walkthrough</h2><h3 id=commit>Commit</h3><p>Commit desired configuration changes to source control (GitHub)</p><p><img src=/p/building-a-datacenter-as-code-with-arista-cloudvision/images/commit1.png width=3840 height=1985 srcset="/p/building-a-datacenter-as-code-with-arista-cloudvision/images/commit1_hu056f45b859ab5b9a3683e1691545dc03_236619_480x0_resize_box_3.png 480w, /p/building-a-datacenter-as-code-with-arista-cloudvision/images/commit1_hu056f45b859ab5b9a3683e1691545dc03_236619_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=193 data-flex-basis=464px></p><h3 id=render-and-upload>Render and Upload</h3><p>Render and upload to CloudVision (staging)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ansible-playbook -i netbox_dynamic_inventory.yml daac-deploy.yml --ask-vault-pass -e <span class=s2>&#34;deploy_hosts=dc-stage&#34;</span> --diff
</span></span></code></pre></div><p><img src=/p/building-a-datacenter-as-code-with-arista-cloudvision/images/ansible1.png width=3804 height=1769 srcset="/p/building-a-datacenter-as-code-with-arista-cloudvision/images/ansible1_hu6457de256260aa72c7bbcc23a36c4b12_153920_480x0_resize_box_3.png 480w, /p/building-a-datacenter-as-code-with-arista-cloudvision/images/ansible1_hu6457de256260aa72c7bbcc23a36c4b12_153920_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=215 data-flex-basis=516px></p><h3 id=deploy-and-execute>Deploy and Execute</h3><p>CloudVision Change Control Executed Successfully</p><p><img src=/p/building-a-datacenter-as-code-with-arista-cloudvision/images/cv1.png width=3840 height=1985 srcset="/p/building-a-datacenter-as-code-with-arista-cloudvision/images/cv1_hu295db26c206a96a59241741ed1909e7d_214868_480x0_resize_box_3.png 480w, /p/building-a-datacenter-as-code-with-arista-cloudvision/images/cv1_hu295db26c206a96a59241741ed1909e7d_214868_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=193 data-flex-basis=464px></p><ul><li>Re-Run playbook changing flag to <strong>Prod</strong></li></ul><p><img src=/p/building-a-datacenter-as-code-with-arista-cloudvision/images/ansible2.png width=3804 height=1769 srcset="/p/building-a-datacenter-as-code-with-arista-cloudvision/images/ansible2_hue2b93abb21344caf64fbfc308e13f597_159018_480x0_resize_box_3.png 480w, /p/building-a-datacenter-as-code-with-arista-cloudvision/images/ansible2_hue2b93abb21344caf64fbfc308e13f597_159018_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=215 data-flex-basis=516px></p><p><img src=/p/building-a-datacenter-as-code-with-arista-cloudvision/images/cv2.png width=3840 height=1985 srcset="/p/building-a-datacenter-as-code-with-arista-cloudvision/images/cv2_hu825723ac80509e1ca5387702654afc55_376889_480x0_resize_box_3.png 480w, /p/building-a-datacenter-as-code-with-arista-cloudvision/images/cv2_hu825723ac80509e1ca5387702654afc55_376889_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=193 data-flex-basis=464px></p><ul><li>Device Overview</li></ul><p><img src=/p/building-a-datacenter-as-code-with-arista-cloudvision/images/cv3.png width=2202 height=1398 srcset="/p/building-a-datacenter-as-code-with-arista-cloudvision/images/cv3_hu2cba48f998c3f597e6b949f86d92e18d_157758_480x0_resize_box_3.png 480w, /p/building-a-datacenter-as-code-with-arista-cloudvision/images/cv3_hu2cba48f998c3f597e6b949f86d92e18d_157758_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=157 data-flex-basis=378px></p><h3 id=test-and-assure>Test and Assure</h3><p>Run Post Validation Checks:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ansible-playbook -i netbox_dynamic_inventory.yml --ask-vault-pass -e <span class=s2>&#34;deploy_hosts=dc-prod&#34;</span> post-change-validate.yml 
</span></span></code></pre></div><p><img src=/p/building-a-datacenter-as-code-with-arista-cloudvision/images/post1.png width=1661 height=434 srcset="/p/building-a-datacenter-as-code-with-arista-cloudvision/images/post1_hub336afe9a5c611a58d53f431e5e08f86_237679_480x0_resize_box_3.png 480w, /p/building-a-datacenter-as-code-with-arista-cloudvision/images/post1_hub336afe9a5c611a58d53f431e5e08f86_237679_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=382 data-flex-basis=918px></p><h2 id=the-code>The Code</h2><h3 id=deploy>Deploy</h3><p>This is the <a class=link href=datacenter-as-code/daac-deploy.yml>playbook</a> that generates the configurations and interacts with Arista CloudVision:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>### Ansible Playbook to Generate Desired Configuration Files for Arista Datacenter Network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>### and run CI Checks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>### and Deploy Configs to Arista Cloudvision Platform</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Arista Cloudvision Datacenter Playbook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Deploy to either stage or prod (use command line extra vars to set) - defaults to stage nev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ deploy_hosts | default(&#39;device_roles_dc-stg&#39;) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># lookup and decrypt vault file from command line --ask-vault-pass. Contains secrets and api keys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars_files</span><span class=p>:</span><span class=w> </span><span class=l>vault.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>connection</span><span class=p>:</span><span class=w> </span><span class=l>local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>False</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># token to use to connect to cvp as a service arista.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ansible_password</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ cvp_token2 }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ansible_httpapi_host</span><span class=p>:</span><span class=w> </span><span class=l>www.arista.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=l>www.arista.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ansible_user</span><span class=p>:</span><span class=w> </span><span class=l>cvaas</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ansible_connection</span><span class=p>:</span><span class=w> </span><span class=l>httpapi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ansible_httpapi_use_ssl</span><span class=p>:</span><span class=w> </span><span class=kc>True</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ansible_httpapi_validate_certs</span><span class=p>:</span><span class=w> </span><span class=kc>False</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ansible_network_os</span><span class=p>:</span><span class=w> </span><span class=l>eos</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ansible_httpapi_port</span><span class=p>:</span><span class=w> </span><span class=m>443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ansible_command_timeout</span><span class=p>:</span><span class=w> </span><span class=m>1200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ansible_connect_timeout</span><span class=p>:</span><span class=w> </span><span class=m>600</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># how long to wait for cvp to commit changes in change control</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>change_wait_timeout</span><span class=p>:</span><span class=w> </span><span class=m>120</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># dict to store configlets per host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>configlets</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Template Lookup and Config Generation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># generate template of system params. Variables are filled in by Netbox (from hostvars pulled to inventory)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{playbook_dir}}/templates/{{ hostvars[inventory_hostname][&#39;config_context&#39;][0][&#39;template_name&#39;] }}.j2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># create a temp candidate config file to be loaded in next task</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{playbook_dir}}/generated_configs/{{ inventory_hostname }}.conf&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>generate_config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Push configlet to CVP&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># for each host, lookup the generated config and push up to cvp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>arista.cvp.cv_configlet_v3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>configlets</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ configlets | combine ({ inventory_hostname : lookup(&#39;file&#39;, &#39;{{playbook_dir}}/generated_configs/&#39;+inventory_hostname+&#39;.conf&#39;) }) }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>configlet_push</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>push_to_cvp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Save taskIDs to file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># for each host, grab the taskID that was created in previous step and save it to a local flat file</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible.builtin.lineinfile</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{playbook_dir}}/task_id_list.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>line</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ configlet_push.taskIds[0] }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>create</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=l>configlet_push.taskIds[0] is defined</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>push_to_cvp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>convert task list file to ansible list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># grab task file created from previous function and create a task id list to be used in next function</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>set_fact</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>taskIds</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ taskIds | default([]) + [item] }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>with_lines</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;cat {{playbook_dir}}/task_id_list.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># only run this once, not for every host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run_once</span><span class=p>:</span><span class=w> </span><span class=kc>True</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>execute_change</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Remove taskid file (delete file)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># delete task file of taskids so it doesnt conflict on future runs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible.builtin.file</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{playbook_dir}}/task_id_list.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>absent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run_once</span><span class=p>:</span><span class=w> </span><span class=kc>True</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>execute_change</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Generate JSON Change File</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># CVP has speciific way to list out multiple changes. Use json template to variablize these for multiple hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;templates/change_vars.j2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{playbook_dir}}/generated_configs/change_vars.json&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run_once</span><span class=p>:</span><span class=w> </span><span class=kc>True</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>execute_change</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Get Change Vars</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Load the previously created change vars file into memory for next task</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible.builtin.include_vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{playbook_dir}}/generated_configs/change_vars.json&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run_once</span><span class=p>:</span><span class=w> </span><span class=kc>True</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>execute_change</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Create a change control on {{inventory_hostname}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># call out to CVP as a service and create a change control window with all the previously created tasks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>arista.cvp.cv_change_control_v3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>set</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>change</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ change }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>cv_change_control</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run_once</span><span class=p>:</span><span class=w> </span><span class=kc>True</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>execute_change</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Approve a change control on {{inventory_hostname}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Approve change window in CVP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>arista.cvp.cv_change_control_v3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>approve_and_execute</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>change_id</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;{{cv_change_control.data.id}}&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run_once</span><span class=p>:</span><span class=w> </span><span class=kc>True</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>execute_change</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Sleep for X seconds while change control executes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># wait for cvp change control window to complete</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible.builtin.wait_for</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{change_wait_timeout}}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>delegate_to</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run_once</span><span class=p>:</span><span class=w> </span><span class=kc>True</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>execute_change</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Check Change Control Status&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># if change window status is completed then we are good, otherwise fail</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>arista.cvp.cv_change_control_v3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>show</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>change_id</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;{{cv_change_control.data.id}}&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>register</span><span class=p>:</span><span class=w> </span><span class=l>change_info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>failed_when</span><span class=p>:</span><span class=w> </span><span class=l>change_info[&#39;data&#39;][&#39;change_controls:&#39;][0][&#39;value&#39;][&#39;status&#39;] != &#39;CHANGE_CONTROL_STATUS_COMPLETED&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run_once</span><span class=p>:</span><span class=w> </span><span class=kc>True</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tags</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>execute_change</span><span class=w>
</span></span></span></code></pre></div><h3 id=templates>Templates</h3><p>We use individual <a class=link href=https://github.com/kaon1/datacenter-as-code-arista-cloudvision/tree/main/datacenter-as-code/templates target=_blank rel=noopener>templates</a> per class of switch and map the generated configuration to a CloudVision Configlet.</p><p><img src=/p/building-a-datacenter-as-code-with-arista-cloudvision/images/cv4.png width=3840 height=1985 srcset="/p/building-a-datacenter-as-code-with-arista-cloudvision/images/cv4_huec3cbd01cc67c547ca3a701fe734508b_211384_480x0_resize_box_3.png 480w, /p/building-a-datacenter-as-code-with-arista-cloudvision/images/cv4_huec3cbd01cc67c547ca3a701fe734508b_211384_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=193 data-flex-basis=464px></p><p>The change_vars <a class=link href=datacenter-as-code/templates/change_vars.j2>file</a> is a datastrucutre created dynamically during runtime. It populates the individual taskIDs generated by cloudvision so we can refer to them in the change control execution window:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;change&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;Change Created By Ansible&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;notes&#34;</span><span class=p>:</span> <span class=s2>&#34;Created via playbook&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;activities&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=err>%</span> <span class=err>for</span> <span class=err>item</span> <span class=err>in</span> <span class=err>taskIds</span> <span class=err>%</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;task_id&#34;</span><span class=p>:</span> <span class=s2>&#34;{{ item }}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;stage&#34;</span><span class=p>:</span> <span class=s2>&#34;ansible_change_window&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=err>%</span> <span class=err>endfor</span> <span class=err>%</span><span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;stages&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;ansible_change_window&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></div><h3 id=cloudvision-service-account>CloudVision Service Account</h3><p>In CloudVision, we must create a service account so that the Ansible Playbook can authenticate. This account username should also exist on your local switches. Create the token and save it in ansible vault or some other secure method when running the playbook.</p><p><img src=/p/building-a-datacenter-as-code-with-arista-cloudvision/images/cv5.png width=1480 height=957 srcset="/p/building-a-datacenter-as-code-with-arista-cloudvision/images/cv5_hu51952622b52d2cc8320f8bfe7bebc07d_86796_480x0_resize_box_3.png 480w, /p/building-a-datacenter-as-code-with-arista-cloudvision/images/cv5_hu51952622b52d2cc8320f8bfe7bebc07d_86796_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=154 data-flex-basis=371px></p><h2 id=creating-the-digital-twin-staging-environment>Creating the Digital Twin Staging Environment</h2><p>I previously published a blog post about the <a class=link href=https://kaonbytes.com/p/self-service-containerlab-deployment-with-ansible-tower/ target=_blank rel=noopener>usefulness of ContainerLab</a></p><p>Arista does a good job of containerizing their EOS image (cEOS). Because of this, we can easily spin up a staging environment and maintain the topology with Infrastructure as Code (IaC) techniques.</p><p>Here is a ContainerLab environment with Arista cEOS images.</p><h3 id=topology>Topology</h3><p>The <a class=link href=datacenter-as-code/containerlab/digitaltwin-staging-build/digitaltwin-staging-build-01.yml>topology file</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>digitaltwin-staging-build</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>prefix</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>topology</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>digitaltwin-staging-build-core01</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ceos</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ceos:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=m>50001</span><span class=p>:</span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>digitaltwin-staging-build-core02</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ceos</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ceos:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=m>50002</span><span class=p>:</span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>digitaltwin-staging-build-access01</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ceos</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ceos:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=m>50003</span><span class=p>:</span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>digitaltwin-staging-build-access02</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ceos</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ceos:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=m>50004</span><span class=p>:</span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>digitaltwin-staging-build-server01</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>linux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;linux:latest&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>TMODE</span><span class=p>:</span><span class=w> </span><span class=l>lacp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=m>50005</span><span class=p>:</span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>digitaltwin-staging-build-client01</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>linux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>linux:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=m>50006</span><span class=p>:</span><span class=m>22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>links</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>endpoints</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>digitaltwin-staging-build-core01:eth1,digitaltwin-staging-build-core02:eth1]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>endpoints</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>digitaltwin-staging-build-core01:eth2,digitaltwin-staging-build-core02:eth2]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>endpoints</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>digitaltwin-staging-build-core01:eth3,digitaltwin-staging-build-access01:eth1]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>endpoints</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>digitaltwin-staging-build-core01:eth4,digitaltwin-staging-build-access02:eth1]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>endpoints</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>digitaltwin-staging-build-core02:eth3,digitaltwin-staging-build-access01:eth2]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>endpoints</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>digitaltwin-staging-build-core02:eth4,digitaltwin-staging-build-access02:eth2]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>endpoints</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>digitaltwin-staging-build-server01:eth1,digitaltwin-staging-build-core01:eth5]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>endpoints</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>digitaltwin-staging-build-server01:eth2,digitaltwin-staging-build-core02:eth5]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>endpoints</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>digitaltwin-staging-build-client01:eth1,digitaltwin-staging-build-access01:eth3]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>mgmt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>network</span><span class=p>:</span><span class=w> </span><span class=l>digitaltwin-staging-build-network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ipv4-subnet</span><span class=p>:</span><span class=w> </span><span class=m>172.100.11.0</span><span class=l>/24</span><span class=w>
</span></span></span></code></pre></div><p>The Topology:</p><p><img src=/p/building-a-datacenter-as-code-with-arista-cloudvision/images/staging-build.png width=2074 height=2604 srcset="/p/building-a-datacenter-as-code-with-arista-cloudvision/images/staging-build_huadfc552134f7e224b6ca6f8af8846b81_222751_480x0_resize_box_3.png 480w, /p/building-a-datacenter-as-code-with-arista-cloudvision/images/staging-build_huadfc552134f7e224b6ca6f8af8846b81_222751_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=79 data-flex-basis=191px></p><p>Docker Containers Running:</p><p><img src=/p/building-a-datacenter-as-code-with-arista-cloudvision/images/dt1.png width=2307 height=518 srcset="/p/building-a-datacenter-as-code-with-arista-cloudvision/images/dt1_hu598800aef1cf40a3d4b5a5b00ca2acb0_114678_480x0_resize_box_3.png 480w, /p/building-a-datacenter-as-code-with-arista-cloudvision/images/dt1_hu598800aef1cf40a3d4b5a5b00ca2acb0_114678_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=445 data-flex-basis=1068px></p><h2 id=wrap-up>Wrap Up</h2><p>I hope you found this post informative and useful in your Network Automation journey. Thanks for reading.</p></section><footer class=article-footer></footer></article><aside class=related-contents--wrapper><h2 class=section-title>Related contents</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/p/self-service-containerlab-deployment-with-ansible-tower/><div class=article-image><img src=/p/self-service-containerlab-deployment-with-ansible-tower/images/clab-ansible.ba505db6de1ab9014b43ae3976868a7e_hu900e690d7d00d8033c3afbeaf3ab65f6_51076_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Self-Service ContainerLab Deployment with Ansible Tower" data-hash="md5-ulBdtt4auQFLQ645doaKfg=="></div><div class=article-details><h2 class=article-title>Self-Service ContainerLab Deployment with Ansible Tower</h2></div></a></article><article class=has-image><a href=/p/golden-configuration-deployment-with-ansible-and-netbox/><div class=article-image><img src=/p/golden-configuration-deployment-with-ansible-and-netbox/golden-config-front.0a95a4dbc7df190c14802b057fde04f9_hu3972f5f5b3bf12cabffe22f75756d981_1247419_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Golden Configuration Deployment with Ansible and Netbox" data-hash="md5-CpWk28ffGQwUgCsFf94E+Q=="></div><div class=article-details><h2 class=article-title>Golden Configuration Deployment with Ansible and Netbox</h2></div></a></article><article class=has-image><a href=/p/ansible-configuration-backup-manager/><div class=article-image><img src=/p/ansible-configuration-backup-manager/_hu12225e3f406182c91634608ad7cb2c64_1239508_1af7a87b45fb3b73a9c1c716fe9eb0f9.png width=250 height=150 loading=lazy alt="Featured image of post Ansible Configuration Backup Manager" data-hash="md5-+TQ8PJ8mkUygm6V0xYsxfQ=="></div><div class=article-details><h2 class=article-title>Ansible Configuration Backup Manager</h2></div></a></article><article class=has-image><a href=/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/><div class=article-image><img src=/p/netbox-dynamic-inventory-for-ansible-as-a-feedback-loop/_hu91008c89e08c35be24c68bc187db22be_244905_6b7b6c28489eabc0762e130a45e366ac.png width=250 height=150 loading=lazy alt="Featured image of post Netbox Dynamic Inventory for Ansible as a feedback loop" data-hash="md5-isvFNqFle3F1LJV2T6/Njg=="></div><div class=article-details><h2 class=article-title>Netbox Dynamic Inventory for Ansible as a feedback loop</h2></div></a></article><article class=has-image><a href=/p/my-first-podcast-interview/><div class=article-image><img src=/p/my-first-podcast-interview/images/cover.232c437fc210a622e0f58f282b3ceb3f_huc2b67065cc238bc9f15887ce24c9ad33_147103_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post My First Podcast Interview" data-hash="md5-IyxDf8IQpiLg9Y8oKzzrPw=="></div><div class=article-details><h2 class=article-title>My First Podcast Interview</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//kaonbytes-com.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2022 -
2024 KaonBytes</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#about>About</a></li><li><a href=#pipeline>Pipeline</a></li><li><a href=#walkthrough>Walkthrough</a><ol><li><a href=#commit>Commit</a></li><li><a href=#render-and-upload>Render and Upload</a></li><li><a href=#deploy-and-execute>Deploy and Execute</a></li><li><a href=#test-and-assure>Test and Assure</a></li></ol></li><li><a href=#the-code>The Code</a><ol><li><a href=#deploy>Deploy</a></li><li><a href=#templates>Templates</a></li><li><a href=#cloudvision-service-account>CloudVision Service Account</a></li></ol></li><li><a href=#creating-the-digital-twin-staging-environment>Creating the Digital Twin Staging Environment</a><ol><li><a href=#topology>Topology</a></li></ol></li><li><a href=#wrap-up>Wrap Up</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>